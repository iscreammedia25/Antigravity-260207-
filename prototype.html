<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Reading Adventure - Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Jua&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --font-fredoka: 'Fredoka', sans-serif;
            --font-jua: 'Jua', sans-serif;
        }

        body {
            font-family: var(--font-fredoka);
            background: linear-gradient(to bottom, #FEFCE8, #EFF6FF);
            /* yellow-50 to blue-50 */
            color: #334155;
            min-height: 100vh;
        }

        .font-jua {
            font-family: var(--font-jua);
        }

        .btn-jelly {
            border-radius: 9999px;
            border-width: 4px;
            border-color: #334155;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-jelly:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
        }

        .card-bubble {
            border-radius: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-width: 6px;
            border-color: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 10px;
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #FFEDD5;
            /* orange-100 */
            border-radius: 9999px;
            border: 3px solid transparent;
            background-clip: padding-box;
            transition: background-color 0.3s;
        }

        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background-color: #FED7AA;
            /* orange-200 */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #FDBA74;
            /* orange-300 */
        }

        .animate-twinkle {
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
                filter: brightness(1.3);
                drop-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            }
        }

        #learningModeOverlay {
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%);
            background-color: #000000;
        }

        #learningModeOverlay.active {
            transform: translateY(0);
        }

        #studyGnb {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        #gnbHandle {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-suck-to-hero {
            animation: suck-to-hero 1.0s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes suck-to-hero {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                left: 50%;
                top: 50%;
            }

            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(-5deg);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.1) rotate(25deg);
                left: var(--target-x, 75%);
                top: var(--target-y, 25%);
            }
        }

        @keyframes flash-yellow {

            0%,
            100% {
                filter: brightness(1) contrast(1);
                transform: scale(1);
            }

            50% {
                filter: brightness(1.2) contrast(1.1);
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
            }
        }

        .animate-flash-yellow {
            animation: flash-yellow 1s infinite;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-12">
        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-6">
                <div
                    class="w-16 h-16 bg-yellow-300 rounded-full border-[6px] border-white shadow-xl flex items-center justify-center overflow-hidden transform hover:scale-110 transition-transform">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Ami" alt="User Avatar">
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-700 tracking-tight font-jua">Ami's Adventure</h1>
                    <div
                        class="flex items-center gap-2 text-green-500 text-sm font-bold bg-green-50 px-3 py-1 rounded-full w-fit mt-1">
                        <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></span>
                        Ready to Learn!
                    </div>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <button id="modeToggleBtn" onclick="toggleMode()"
                    class="px-6 py-3 rounded-2xl text-sm font-black transition-all border-[3px] shadow-sm bg-sky-500 text-white border-sky-400 shadow-sky-100 hover:scale-105 active:scale-95">
                    HISTORY MODE
                </button>
                <button
                    class="w-14 h-14 bg-white rounded-3xl shadow-lg flex items-center justify-center text-slate-400 hover:text-orange-500 transition-all border-4 border-white active:scale-95"><i
                        data-lucide="bell" class="w-7 h-7"></i></button>
                <button
                    class="w-14 h-14 bg-white rounded-3xl shadow-lg flex items-center justify-center text-slate-400 hover:text-orange-500 transition-all border-4 border-white active:scale-95"><i
                        data-lucide="menu" class="w-7 h-7"></i></button>
            </div>
        </header>

        <!-- Hero Section -->
        <!-- Hero Section Container -->
        <div id="heroContainer">
            <!-- Will be rendered by script -->
        </div>

        <!-- Library Section -->
        <div class="card-bubble p-8 md:p-10 w-full relative">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-4xl font-black text-slate-700 flex items-center gap-5 font-jua">
                    <span
                        class="w-14 h-14 bg-sky-100 rounded-[20px] flex items-center justify-center text-sky-400 shadow-sm shadow-sky-100 transform rotate-3">
                        <i data-lucide="sparkles" class="w-9 h-9 fill-current"></i>
                    </span>
                    Recommended for Ami
                </h3>
                <a href="#"
                    class="px-6 py-4 bg-sky-50 text-sky-400 font-black btn-jelly text-sm flex items-center gap-3 hover:bg-sky-100 group">
                    SEE ALL <i data-lucide="chevron-right"
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>

            <div class="relative group/scroll px-4">
                <!-- Bookshelf Base -->
                <div
                    class="absolute bottom-10 left-0 right-0 h-16 bg-slate-200/40 rounded-full mx-6 border-b-4 border-slate-300/20">
                </div>

                <button id="scrollLeftBtn" onclick="scrollContainer(-400)"
                    class="absolute left-0 top-[35%] -translate-y-1/2 -translate-x-6 w-14 h-14 bg-white text-sky-400 rounded-full shadow-lg border border-slate-100 flex items-center justify-center z-20 opacity-0 group-hover/scroll:opacity-100 transition-all hover:bg-sky-50 active:scale-90 invisible">
                    <i data-lucide="chevron-left" class="w-9 h-9"></i>
                </button>

                <div id="bookContainer"
                    class="flex gap-4 md:gap-6 overflow-x-auto pt-10 pb-12 scroll-smooth custom-scrollbar relative z-10 cursor-grab active:cursor-grabbing select-none">
                    <!-- Books will be injected by script -->
                </div>

                <button onclick="scrollContainer(400)"
                    class="absolute right-0 top-[35%] -translate-y-1/2 translate-x-6 w-14 h-14 bg-white text-sky-400 rounded-full shadow-lg border border-slate-100 flex items-center justify-center z-20 opacity-0 group-hover/scroll:opacity-100 transition-all hover:bg-sky-50 active:scale-90">
                    <i data-lucide="chevron-right" class="w-9 h-9"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="bookModal" class="fixed inset-0 z-60 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="card-bubble w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col relative z-10 scale-95 opacity-0 transition-all duration-300"
            id="modalContent">
            <!-- Bookmark Ribbon - Stuck to Top -->
            <div class="absolute top-0 left-12 z-20 pointer-events-none">
                <button onclick="toggleBookmarkModal()" id="modalBookmarkBtn"
                    class="w-16 h-24 flex items-center justify-center pt-2 pb-8 transition-all pointer-events-auto active:scale-95 shadow-xl rounded-b-3xl border-[6px] border-t-0 border-white bg-white text-slate-200">
                    <i data-lucide="bookmark" id="modalBookmarkIcon" class="w-10 h-10"></i>
                </button>
            </div>

            <!-- Modal Header -->
            <div class="p-6 md:p-8 flex justify-between items-center border-b-[6px] border-slate-50">
                <div class="w-16"></div> <!-- Spacer for ribbon -->
                <h2 id="modalTitle"
                    class="text-3xl md:text-4xl font-black text-slate-700 font-jua text-center flex-1 mx-4 truncate">
                    Book Title
                </h2>
                <button onclick="closeModal()"
                    class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 md:p-10">
                <div class="flex flex-col md:flex-row gap-10">
                    <div class="w-full md:w-1/2 flex-shrink-0">
                        <div
                            class="aspect-[3/4] rounded-[48px] overflow-hidden border-[8px] border-white shadow-2xl shadow-slate-200">
                            <img id="modalImg" src="" alt="" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 space-y-8">
                        <div class="flex flex-wrap gap-3">
                            <span id="modalLexile"
                                class="px-5 py-2 bg-orange-100 text-orange-500 rounded-full font-black text-sm border-2 border-orange-200">Lexile:
                                300</span>
                            <span id="modalWords"
                                class="px-5 py-2 bg-green-100 text-green-500 rounded-full font-black text-sm border-2 border-green-200">140
                                Words</span>
                            <span id="modalCategory"
                                class="px-5 py-2 bg-sky-100 text-sky-500 rounded-full font-black text-sm border-2 border-sky-200">Science</span>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xl font-black text-slate-800 font-jua">Summary</h4>
                            <p id="modalSummary" class="text-lg text-slate-600 leading-relaxed font-fredoka">Summary
                                goes here...</p>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xl font-black text-slate-800 font-jua">Keywords</h4>
                            <div id="modalKeywords" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-8 md:p-10 bg-slate-50/50 flex justify-center">
                <button onclick="startLearning()" id="modalStartBtn"
                    class="w-full md:max-w-md py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl">
                    START READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Mode Overlay -->
    <div id="learningModeOverlay"
        class="fixed inset-0 z-[100] bg-black hidden overflow-hidden shadow-[0_-20px_50px_rgba(0,0,0,0.3)]">
        <!-- Floating GNB Wrapper -->
        <div id="gnbWrapper" class="fixed top-0 inset-x-0 z-[110]">
            <nav id="studyGnb"
                class="h-24 px-8 flex items-center justify-between shadow-xl border-b-2 border-slate-100">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-500 shadow-inner">
                        <i data-lucide="video" class="w-7 h-7 fill-current"></i>
                    </div>
                    <h2 id="studyBookTitle" class="text-2xl font-black text-slate-700 font-jua">Book Title</h2>
                </div>

                <!-- Phase Tabs -->
                <div class="flex bg-slate-100 p-1.5 rounded-2xl gap-1">
                    <button id="tab-watch" onclick="setPhase('watch')"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 bg-white text-orange-500 shadow-sm">
                        <i data-lucide="play-circle" class="w-4 h-4 fill-current"></i> Watch
                    </button>
                    <button id="tab-read" onclick="setPhase('read')"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="book-open" class="w-4 h-4"></i> Read <i data-lucide="lock" class="w-3 h-3"></i>
                    </button>
                    <button id="tab-quiz"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="help-circle" class="w-4 h-4"></i> Quiz <i data-lucide="lock"
                            class="w-3 h-3"></i>
                    </button>
                    <button id="tab-talk"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> Talk <i data-lucide="lock"
                            class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="w-48 flex justify-end">
                    <button id="gnbCloseBtn" onclick="exitLearningMode()"
                        class="w-14 h-14 bg-slate-50 rounded-2xl border-4 border-white flex items-center justify-center text-slate-400 shadow-sm hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-all active:scale-95 group">
                        <i data-lucide="x" class="w-8 h-8 group-hover:rotate-90 transition-transform"></i>
                    </button>
                </div>

                <!-- The Handle (Sticky to top when GNB hides) -->
                <button id="gnbHandle" onclick="toggleGnb(true); event.stopPropagation();"
                    class="absolute -bottom-10 left-1/2 -translate-x-1/2 w-24 h-10 bg-white border-b-4 border-x-4 border-slate-50 rounded-b-[32px] flex items-center justify-center text-slate-300 hover:text-sky-400 shadow-lg transition-all active:h-12 pointer-events-auto">
                    <i data-lucide="chevron-up" id="gnbHandleIcon" class="w-8 h-8"></i>
                </button>
            </nav>
        </div>

        <!-- Study Content Area -->
        <main id="mainContent" class="w-full h-full bg-black flex items-center justify-center relative cursor-pointer"
            onclick="handleMainClick()">
            <!-- Watch Phase -->
            <div id="phase-watch" class="w-full h-full flex items-center justify-center p-4">
                <div
                    class="w-full h-full max-w-screen-2xl min-h-[60vh] bg-black rounded-[24px] overflow-hidden relative group">
                    <video id="studyVideo" class="w-full h-full object-contain pointer-events-auto"
                        onplay="document.getElementById('nextPhaseContainer').classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');"
                        onended="onVideoEnded()" playsinline src="./public/Video/the_silent_stick_watch.mp4"></video>

                    <!-- Custom Video Controls -->
                    <div id="videoControls"
                        class="absolute bottom-0 inset-x-0 h-24 bg-gradient-to-t from-black/80 to-transparent flex items-center px-10 gap-8 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button onclick="togglePlay()" class="text-white hover:scale-110 transition-transform">
                            <i data-lucide="play" id="playIcon" class="w-10 h-10 fill-current"></i>
                        </button>

                        <div class="flex items-center gap-4">
                            <button onclick="skipVideo(-3)" class="text-white/80 hover:text-white transition-colors">
                                <i data-lucide="rotate-ccw" class="w-7 h-7"></i>
                            </button>
                            <button onclick="skipVideo(3)" class="text-white/80 hover:text-white transition-colors">
                                <i data-lucide="rotate-cw" class="w-7 h-7"></i>
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div class="flex-1 h-2 bg-white/20 rounded-full overflow-hidden cursor-pointer relative"
                            onclick="seekVideo(event)">
                            <div id="videoProgress" class="absolute inset-y-0 left-0 bg-sky-400 rounded-full w-0"></div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="cyclePlaybackRate()"
                                class="px-4 py-1.5 bg-white/10 text-white rounded-xl text-sm font-black border border-white/20 hover:bg-white/20">
                                <span id="playbackRateText">1.0x</span>
                            </button>
                        </div>
                    </div>

                    <!-- Next Button (hidden initially) -->
                    <div id="nextPhaseContainer"
                        class="absolute bottom-12 right-12 transition-all duration-500 transform translate-y-10 opacity-0 pointer-events-none z-60">
                        <button onclick="setPhase('read')"
                            class="px-10 py-5 bg-[#FF6B00] text-white rounded-3xl font-black text-xl flex items-center gap-3 shadow-2xl animate-twinkle hover:scale-105 active:scale-95 transition-all">
                            Read Next <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Big Play/Pause Button Overlay (YouTube Style) -->
                    <div id="videoCentralOverlay"
                        class="absolute inset-0 bg-black/20 flex items-center justify-center z-20 transition-all duration-300 pointer-events-none">
                        <button onclick="togglePlay(); event.stopPropagation();"
                            class="w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/30 shadow-2xl hover:scale-110 active:scale-95 transition-all group pointer-events-auto">
                            <i data-lucide="play" id="centralPlayIcon" class="w-16 h-16 fill-current"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Read Phase - 3 Steps Flow -->
            <div id="phase-read" class="w-full h-full flex flex-col relative z-30 overflow-hidden hidden">
                <!-- Background Layer: Cover Image (Darkened) -->
                <div id="read-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-1000"
                    style="filter: brightness(0.3) blur(8px)">
                </div>
                <!-- Dynamic Content Container -->
                <div id="phaseContainer" class="flex-1 flex flex-col relative z-40 overflow-hidden">
                    <!-- renderReadPhase() will inject content here -->
                </div>

                <!-- [NEW] Settings Popup Overlay -->
                <div id="settingsOverlay" class="fixed inset-0 z-[140] bg-black/40 backdrop-blur-sm hidden"
                    onclick="toggleSettings()">
                    <div class="fixed inset-0 z-[140] flex items-center justify-center pointer-events-none">
                        <div class="bg-slate-800/90 backdrop-blur-2xl rounded-[40px] p-10 w-[600px] shadow-2xl border-2 border-white/10 pointer-events-auto relative"
                            onclick="event.stopPropagation()">
                            <button onclick="toggleSettings()"
                                class="absolute top-6 right-6 text-white/40 hover:text-white transition-colors">
                                <i data-lucide="x" class="w-8 h-8"></i>
                            </button>
                            <h2 class="text-4xl font-black text-white font-fredoka mb-10 text-center">Setting</h2>
                            <div class="flex flex-col gap-8">
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-bold text-white font-fredoka">Narration</span>
                                    <div id="narrationToggle" onclick="setNarration(!isNarrationOn)"
                                        class="w-24 h-12 rounded-full p-1 cursor-pointer transition-colors flex items-center bg-slate-600">
                                        <div
                                            class="toggle-knob w-10 h-10 bg-white rounded-full shadow-lg transition-transform duration-300 flex items-center justify-center font-black text-xs text-slate-800">
                                            off</div>
                                    </div>
                                </div>
                                <div id="pageTurnRow"
                                    class="flex items-center justify-between opacity-30 pointer-events-none">
                                    <span class="text-2xl font-bold text-white font-fredoka">Page Turn</span>
                                    <div id="pageTurnToggle" onclick="setPageTurn(!isPageTurnOn)"
                                        class="w-24 h-12 rounded-full p-1 cursor-pointer transition-colors flex items-center bg-slate-600">
                                        <div
                                            class="toggle-knob w-10 h-10 bg-white rounded-full shadow-lg transition-transform duration-300 flex items-center justify-center font-black text-xs text-slate-800">
                                            off</div>
                                    </div>
                                </div>
                                <div id="narrationSpeedRow" class="flex flex-col gap-4 opacity-30 pointer-events-none">
                                    <span class="text-lg font-bold text-white/60 font-fredoka">Narration Speed</span>
                                    <div class="flex gap-4">
                                        <button onclick="setNarrationSpeed(0.8)" id="speed-0.8"
                                            class="flex-1 py-3 rounded-2xl font-black text-xl bg-slate-700 text-white/60">Slow</button>
                                        <button onclick="setNarrationSpeed(1.0)" id="speed-1.0"
                                            class="flex-1 py-3 rounded-2xl font-black text-xl bg-white text-slate-900 shadow-xl scale-105">Normal</button>
                                        <button onclick="setNarrationSpeed(1.2)" id="speed-1.2"
                                            class="flex-1 py-3 rounded-2xl font-black text-xl bg-slate-700 text-white/60">Fast</button>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <span class="text-lg font-bold text-white/60 font-fredoka">Text Size</span>
                                    <div class="flex gap-4">
                                        <button onclick="setTextSize('normal')" id="size-normal"
                                            class="flex-1 py-3 rounded-2xl font-black bg-slate-700 text-white/60 text-lg">Text</button>
                                        <button onclick="setTextSize('large')" id="size-large"
                                            class="flex-1 py-3 rounded-2xl font-black bg-white text-slate-900 shadow-xl scale-105 text-xl">Text</button>
                                        <button onclick="setTextSize('medium')" id="size-medium"
                                            class="flex-1 py-3 rounded-2xl font-black bg-slate-700 text-white/60 text-2xl">Text</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [NEW] Shared Scene Picker Overlay -->
                <div id="scenePickerOverlay" class="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm hidden"
                    onclick="toggleScenePicker()">
                    <div class="absolute bottom-0 inset-x-0 bg-black/95 backdrop-blur-3xl border-t-2 border-white/10 z-[70] p-12 transition-all duration-500 flex flex-col gap-8"
                        onclick="event.stopPropagation()">
                        <button onclick="toggleScenePicker()" class="w-full flex justify-center group">
                            <div
                                class="bg-white/10 rounded-full px-12 py-3 border border-white/20 flex items-center gap-4 hover:bg-white/20 transition-all">
                                <i data-lucide="chevron-down" class="text-white w-8 h-8"></i>
                                <span class="text-white font-black uppercase tracking-widest text-xl">Close
                                    Picker</span>
                            </div>
                        </button>
                        <div id="sceneThumbnails" class="flex gap-6 overflow-x-auto pb-10 scrollbar-hide snap-x pt-4">
                            <!-- JS will inject thumbnails here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. State Variables & Initial Data ---
        let unlockedPhases = ['watch'];
        let FreshHero = null;
        let selectedScenes = [];
        let currentModalBookId = null;
        let isHistoryMode = true;
        let currentHeroIndex = 1;
        let isHeroCTAFlashing = false;
        let currentModalOrigin = 'recommendation';

        let currentPhase = 'home';
        let currentReadStep = 'selection';
        let currentSceneIndex = 0;
        let maxReachedSceneIndex = 0;
        let selectedReadingMode = 'ebook';

        // Settings State
        let isSettingsOpen = false;
        let isNarrationOn = false;
        let isPageTurnOn = false;
        let narrationSpeed = 1;
        let textSize = "large";

        // Audio State
        let currentAudio = null;
        let playingSentenceIndex = null;
        let isSceneAudioPlaying = false;
        let isScenePickerOpen = false;

        const booksData = [
            { id: 'missing-planet', title: 'The Missing Planet', src: './public/Image/Cover/The Missing Planet.png', lexile: '250~300', wordCount: 120, category: 'Space ðŸš€', summary: 'A brave little astronaut goes on a mission to find a planet that disappeared from the star maps. Join the cosmic adventure!', keywords: ['planet', 'space', 'astronaut', 'star'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'rainbow', title: 'Rainbow', src: './public/Image/Cover/Rainbow.png', lexile: '150~200', wordCount: 85, category: 'Nature ðŸŒˆ', summary: 'Follow the beautiful colors across the sky after a rainy day. Learn how rainbows are made of light and magic!', keywords: ['color', 'rain', 'sky', 'sun'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'two-friends', title: 'Two Friends', src: './public/Image/Cover/Two Friends.png', lexile: '200~250', wordCount: 110, category: 'Friendship ðŸ¤', summary: 'A story about a rabbit and a turtle who discover that being different is what makes their friendship so special.', keywords: ['friends', 'together', 'help', 'game'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'silent-seed', title: 'The Silent Seed', src: './public/Image/Cover/The Silent Seed.png', lexile: '300~350', wordCount: 145, category: 'Science ðŸ”¬', summary: 'Deep under the ground, a tiny seed waits silently for the perfect moment to grow into a magnificent tree.', keywords: ['grow', 'wait', 'ground', 'leaf'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', lexile: '250~320', wordCount: 130, category: 'Adventure ðŸ—ºï¸', summary: 'A magic stick that doesn\'t make a sound helps a quiet boy find his way through a mysterious forest.', keywords: ['magic', 'quiet', 'forest', 'path'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'broken-branch', title: 'The Broken Branch', src: './public/Image/Cover/The Broken Branch.png', lexile: '280~340', wordCount: 135, category: 'Nature ðŸŒ³', summary: 'When a strong wind breaks a branch, the forest animals work together to make it a new home for a bird family.', keywords: ['tree', 'wind', 'home', 'birds'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'pea', title: 'The Pea', src: './public/Image/Cover/The Pea.png', lexile: '180~230', wordCount: 95, category: 'Food ðŸ«›', summary: 'One tiny green pea rolls off the plate and travels across the kitchen floor. Where will it end up?', keywords: ['green', 'roll', 'kitchen', 'floor'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', lexile: '320~380', wordCount: 160, category: 'Animals ðŸ¶', summary: 'Milo is a dog with a very big imagination. Every time he goes for a walk, he sees a world full of dragons.', keywords: ['dog', 'dream', 'adventure', 'wild'], isBookmarked: false, videoUrl: './public/Video/milo_and_the_lost_color_watch.mp4' },
            { id: 'rainbow-cloud', title: 'Rainbow Cloud', src: './public/Image/Cover/The Rainbow Cloud.png', lexile: '350~400', wordCount: 180, category: 'Fantasy âœ¨', summary: 'A magical cloud that rains colors instead of water changes everything in the gray city of Grumbletown.', keywords: ['magic', 'cloud', 'color', 'happy'], isBookmarked: true, videoUrl: './public/Video/rainbow_cloud_watch.mp4' },
            { id: 'cindellar', title: 'Cindellar', src: './public/Image/Cover/Cindellar.png', lexile: '380~450', wordCount: 210, category: 'Classic ðŸ°', summary: 'A new retelling of the classic fairy tale with a focus on being kind to yourself and others.', keywords: ['princess', 'kind', 'dance', 'shoe'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'flying-trunk', title: 'The Flying Trunk', src: './public/Image/Cover/The Fyling Trunk.png', lexile: '340~390', wordCount: 175, category: 'Adventure ðŸ—ºï¸', summary: 'Travel the world in a magic trunk that can fly over mountains and oceans.', keywords: ['fly', 'travel', 'ocean', 'magic'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'rapunzel', title: 'The Rapunzel', src: './public/Image/Cover/The Rapunzel.png', lexile: '360~410', wordCount: 190, category: 'Classic ðŸ°', summary: 'A story about inner strength and finding your own voice from high up in a stone tower.', keywords: ['hair', 'tower', 'voice', 'strong'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'ugly-dukling', title: 'The Ugly Dukling', src: './public/Image/Cover/The Ugly Dukling.png', lexile: '300~360', wordCount: 155, category: 'Animals Swan', summary: 'Discover how being different can lead to finding where you truly belong.', keywords: ['different', 'belong', 'lake', 'swan'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
        ];

        let mockHistory = [
            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', progress: 50, phase: 'quiz', completedPhases: ['watch', 'read'] },
            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', progress: 0, phase: 'watch', completedPhases: [] },
            { id: 'empty-placeholder', title: '', src: '', progress: 0, phase: '', completedPhases: [], isPlaceholder: true }
        ];

        const mockScenes = [
            { id: "silent-stick", scene_no: "SC01", script: "The frozen lake lay still, \na big area of gray ice \nbeneath a heavy winter sky.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.mp3" },
            { id: "silent-stick", scene_no: "SC02", script: "He hit the puck with force, \nbut his old stick broke \nsuddenly upon impact.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.mp3" },
            { id: "silent-stick", scene_no: "SC03", script: "Two pieces of wood lay on the ice, \nshowing the end of his practice.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC03.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC03.mp3" },
            { id: "silent-stick", scene_no: "SC04", script: "Ren worked for hours, \ncutting the skin to show \nthe hard wood under.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC04.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC04.mp3" },
            { id: "silent-stick", scene_no: "SC05", script: "When he tested it, \nthe puck flew in strange circles \ndue to the woodâ€™s natural shape.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC05.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC05.mp3" },
            { id: "silent-stick", scene_no: "SC06", script: "Jax glanced at Renâ€™s rough branch \nand offered a cold smile, saying nothing.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC06.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC06.mp3" },
            { id: "silent-stick", scene_no: "SC07", script: "Jax controlled the ice, \nhis speed pushing Ren \nback toward his own goal.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC07.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC07.mp3" },
            { id: "silent-stick", scene_no: "SC08", script: "The puck turned around the confused player, \ngoing quietly into the net as the whistle blew.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC08.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC08.mp3" },
            { id: "silent-stick", scene_no: "SC09", script: "Ren smiled at his rough stick \nand skated away silently.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC09.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC09.mp3" },
            { id: "milo", scene_no: "SC01", script: "Milo is a dog with a very big imagination.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.mp3" },
            { id: "milo", scene_no: "SC02", script: "Every time he goes for a walk, \nhe sees a world full of dragons.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.mp3" }
        ];

        // --- 2. Action Functions ---

        function getTextPositionClass(index) {
            switch (index) {
                case 0: return "top-8 left-8 md:top-16 md:left-16 text-left items-start";
                case 1:
                case 2:
                case 4: return "top-8 right-8 md:top-16 md:right-16 text-left items-start";
                case 3: return "bottom-24 right-8 md:bottom-32 md:right-16 text-left items-start";
                case 5:
                case 6:
                case 7: return "bottom-24 left-8 md:bottom-32 md:left-16 text-left items-start";
                case 8: return "top-1/2 -translate-y-1/2 left-24 md:left-32 text-left items-start";
                default: return "top-8 left-8 md:top-16 md:left-16 text-left items-start";
            }
        }

        window.toggleMode = function () {
            isHistoryMode = !isHistoryMode;
            currentHeroIndex = 0;
            const btn = document.getElementById('modeToggleBtn');
            if (isHistoryMode) {
                btn.innerText = 'HISTORY MODE';
                btn.classList.remove('bg-white', 'text-slate-400', 'border-slate-100');
                btn.classList.add('bg-sky-500', 'text-white', 'border-sky-400', 'shadow-sky-100');
            } else {
                btn.innerText = 'FRESH MODE';
                btn.classList.add('bg-white', 'text-slate-400', 'border-slate-100');
                btn.classList.remove('bg-sky-500', 'text-white', 'border-sky-400', 'shadow-sky-100');
            }
            renderHero();
        }

        function renderHero() {
              const container = document.getElementById('heroContainer');
            const isHistory = isHistoryMode;
            const items = isHistory ? mockHistory : [
                FreshHero || booksData.find(b => b.id === 'silent-stick')
            ];

            const userName = "Ami";
            const safeIndex = currentHeroIndex >= items.length ? 0 : currentHeroIndex; // lint: Ensure index is within bounds.
            const item = items[safeIndex];
            if (item) currentModalBookId = item.id; // lint: Safely set currentModalBookId.
            const prevIdx = (currentHeroIndex - 1 + items.length) % items.length;
            const nextIdx = (currentHeroIndex + 1) % items.length;
            const prevItem = items[prevIdx];
            const nextItem = items[nextIdx];

            const progress = (isHistory && item && !item.isPlaceholder) ? item.progress : 0;
            const phasesText = (isHistory && item && !item.isPlaceholder) ? `
                <div class="flex gap-3 mb-1">
                    <span class="text-xs uppercase ${item.completedPhases.includes('watch') ? 'text-green-400' : 'text-yellow-300 font-black'}">watch</span>
                    <span class="text-xs uppercase ${item.phase === 'read' ? 'text-yellow-300 font-black' : item.completedPhases.includes('read') ? 'text-green-400' : 'opacity-40'}">> read</span>
                    <span class="text-xs uppercase ${item.phase === 'quiz' ? 'text-yellow-300 font-black' : item.completedPhases.includes('quiz') ? 'text-green-400' : 'opacity-40'}">> quiz</span>
                    <span class="text-xs uppercase ${item.phase === 'speak' ? 'text-yellow-300 font-black' : 'opacity-40'}">> speak</span>
                </div>
            ` : '<div class="text-xs uppercase opacity-40">watch > read > quiz > speak</div>';

            let prevSlotHtml = '';
            if (isHistory && items.length > 1) {
                const prevContent = prevItem.isPlaceholder ? `
                    <div class="w-full h-full border-4 border-dashed border-white/30 rounded-[28px] flex flex-col items-center justify-center gap-2">
                        <div class="w-12 h-12 rounded-full border-2 border-dashed border-white/30 flex items-center justify-center">
                            <span class="text-white/20 text-3xl font-black">+</span>
                        </div>
                    </div>` : `<img src="${prevItem.src}" class="w-full h-full object-cover brightness-90">`;

                prevSlotHtml = `
                    <div id="hero-left-slot" data-index="${prevIdx}" class="absolute left-[-22%] scale-75 opacity-70 pointer-events-none transform -rotate-6 transition-all duration-500">
                        <div class="w-48 h-64 bg-slate-900/60 backdrop-blur-md rounded-[28px] shadow-xl overflow-hidden border-2 border-white/20">
                            ${prevContent}
                        </div>
                    </div>`;
            }

            const mainCardInner = item.isPlaceholder ? `
                <div class="w-full h-full border-4 border-dashed border-white/20 rounded-[28px] flex flex-col items-center justify-center gap-4 bg-slate-900/20">
                    <div class="w-20 h-20 rounded-full border-4 border-dashed border-white/20 flex items-center justify-center">
                        <span class="text-white/20 text-5xl font-black">+</span>
                    </div>
                    <p class="text-white/20 font-black text-xl uppercase tracking-widest">Empty</p>
                </div>` : `
                <img src="${item.src}" class="w-full h-full object-cover">
                <div class="absolute top-4 left-4 z-20">
                    <div class="bg-black/40 backdrop-blur-md px-3 py-1 rounded-full border border-white/20">
                        <p class="text-white font-black text-[9px] uppercase tracking-widest opacity-90">${isHistory ? 'In Progress' : 'Recommended'}</p>
                    </div>
                </div>
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent flex flex-col justify-end p-5 min-h-[40%]">
                    <h3 class="text-white font-black leading-tight text-center" style="font-size: ${item.title.length > 20 ? '14px' : '18px'}">${item.title}</h3>
                </div>`;

            let navButtonsHtml = '';
            if (isHistory && items.length > 1) {
                navButtonsHtml = `
                    <div class="absolute inset-y-0 -left-6 -right-6 flex items-center justify-between pointer-events-none">
                        <button onclick="event.stopPropagation(); navigateHero(-1)" class="w-10 h-10 bg-white/30 hover:bg-white/50 backdrop-blur-md rounded-full flex items-center justify-center text-white pointer-events-auto border border-white/40 shadow-lg transition-all active:scale-90"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                        <button onclick="event.stopPropagation(); navigateHero(1)" class="w-10 h-10 bg-white/30 hover:bg-white/50 backdrop-blur-md rounded-full flex items-center justify-center text-white pointer-events-auto border border-white/40 shadow-lg transition-all active:scale-90"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                    </div>`;
            }

            let nextSlotHtml = '';
            if (isHistory && items.length > 1) {
                const nextContent = nextItem.isPlaceholder ? `
                    <div class="w-full h-full border-4 border-dashed border-white/30 rounded-[28px] flex flex-col items-center justify-center gap-2">
                        <div class="w-12 h-12 rounded-full border-2 border-dashed border-white/30 flex items-center justify-center">
                            <span class="text-white/20 text-3xl font-black">+</span>
                        </div>
                    </div>` : `<img src="${nextItem.src}" class="w-full h-full object-cover brightness-90">`;

                nextSlotHtml = `
                    <div id="hero-right-slot" data-index="${nextIdx}" class="absolute right-[-22%] scale-75 opacity-70 pointer-events-none transform rotate-6 transition-all duration-500">
                        <div class="w-48 h-64 bg-slate-900/60 backdrop-blur-md rounded-[28px] shadow-xl overflow-hidden border-2 border-white/20">
                            ${nextContent}
                        </div>
                    </div>`;
            }

            const titleText = isHistory ? `Continue Your<br>Adventure, ${userName}!` : `Start Your<br>Adventure, ${userName}!`;
            const progressValue = isHistory ? (progress > 0 ? Math.max(progress, 5) : 0) : 100;
            const buttonText = isHistory ? 'CONTINUE READING' : 'START READING';
            const buttonClass = isHistory ? 'bg-[#fbbf24] text-[#0f172a] shadow-amber-900/40' : 'bg-[#0f172a] text-white hover:bg-[#1e293b] shadow-amber-900/20';

            container.innerHTML = `
                <section class="card-bubble relative overflow-hidden p-6 md:p-10 transition-all duration-700 border-none shadow-2xl ${isHistory ? 'bg-[#0f172a]' : 'bg-[#fbbf24]'} min-h-[360px] flex items-center">
                    <div id="heroContentChunk" class="flex flex-col md:flex-row items-center gap-12 w-full relative z-10 animate-in fade-in slide-in-from-right duration-500">
                        <!-- Book Display Unit -->
                        <div class="relative flex items-center justify-center w-full md:w-[320px] h-[340px] flex-shrink-0">
                            ${prevSlotHtml}
                            <!-- Main Hero Card -->
                            <div id="hero-center-slot" data-index="${currentHeroIndex}" class="relative z-10 group">
                                <div class="w-56 h-[280px] rounded-[28px] shadow-2xl overflow-hidden transform border-4 ${isHistory ? 'border-white' : 'border-[#0f172a]/10'} transition-all group-hover:scale-105 cursor-pointer ${item.isPlaceholder ? 'bg-slate-900/60 backdrop-blur-xl' : 'bg-white'}" 
                                     onclick="${item.isPlaceholder ? '' : `openModal('${item.id}', '${isHistory ? 'history' : 'recommendation'}')`}">
                                    ${mainCardInner}
                                </div>
                                ${navButtonsHtml}
                            </div>
                            ${nextSlotHtml}
                        </div>

                        <!-- Right: Text & Actions Unit -->
                        <div class="flex-1 space-y-8 text-center md:text-left transition-all duration-700 md:pl-16 ${isHistory ? 'text-white' : 'text-[#0f172a]'}">
                            <div class="space-y-4">
                                <h2 class="text-5xl md:text-7xl font-black font-fredoka drop-shadow-md leading-tight whitespace-nowrap">
                                    ${titleText}
                                </h2>
                            </div>

                            <div class="space-y-3 max-w-2xl">
                                <div class="flex flex-col md:flex-row items-baseline justify-between font-black font-fredoka gap-6 ${isHistory ? 'text-white' : 'text-[#0f172a]'}">
                                    <div class="flex flex-wrap gap-x-8 gap-y-2 uppercase tracking-normal font-black" style="font-size: clamp(1.5rem, 4vw, 3.5rem); line-height: 1;">
                                        ${phasesText}
                                    </div>
                                    <div class="flex items-baseline gap-4 font-black ${isHistory ? 'text-sky-100' : 'text-[#0f172a]'}" style="font-size: clamp(2rem, 5vw, 3rem); line-height: 1;">
                                        ${progress}% <span class="opacity-80 uppercase" style="font-size: 0.6em;">Completed!</span>
                                    </div>
                                </div>

                                <div class="h-4 w-full rounded-full overflow-hidden border p-1 shadow-inner ${isHistory ? 'bg-black/20 border-white/10' : 'bg-[#0f172a]/10 border-[#0f172a]/10'}">
                                    <div class="h-full rounded-full transition-all duration-1000 bg-gradient-to-r ${isHistory ? 'from-sky-400 to-blue-400 shadow-[0_0_20px_rgba(56,189,248,0.4)]' : 'from-orange-500 to-orange-400 shadow-[0_0_20px_rgba(249,115,22,0.2)]'}" style="width: ${progressValue}%"></div>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button onclick="startLearning()" class="w-full md:max-w-md py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl ${buttonClass} ${isHeroCTAFlashing ? 'animate-flash-yellow' : ''}">
                                    ${buttonText} <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>`;
            lucide.createIcons();
        }

        function navigateHero(dir) {
            currentHeroIndex = (currentHeroIndex + dir + mockHistory.length) % mockHistory.length;
            renderHero();
        }

        function renderBooks() {
             const container = document.getElementById('bookContainer');
            container.innerHTML = booksData.map(book => `
                <div key="${book.id}" onclick="openModal('${book.id}', 'recommendation')" class="w-36 md:w-40 flex-shrink-0 group cursor-pointer space-y-3 relative select-none">
                    <div class="aspect-[3/4] bg-slate-50 rounded-[32px] shadow-sm border-[4px] border-white group-hover:border-sky-300 transition-all group-hover:-translate-y-3 group-hover:shadow-2xl group-hover:shadow-sky-100 overflow-hidden relative">
                        <img src="${book.src}" class="w-full h-full object-cover pointer-events-none">
                        <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <!-- Card Bookmark Ribbon -->
                        ${book.isBookmarked ? `
                        <div class="absolute top-0 left-4 z-10 transition-transform group-hover:scale-110">
                            <div class="w-10 h-12 flex items-center justify-center pt-1 pb-4 rounded-b-xl border-2 border-t-0 border-white shadow-md transition-all bg-[#FF6B00] text-white">
                                <i data-lucide="bookmark" class="w-6 h-6 fill-current"></i>
                            </div>
                        </div>` : ''}
                    </div>
                    <p class="text-[10px] font-black text-center text-slate-400 truncate px-4 uppercase tracking-[0.15em] group-hover:text-sky-400 transition-colors font-fredoka">${book.title}</p>
                </div>
                `).join('');
            lucide.createIcons();
        }

        function openModal(bookId, origin = 'recommendation') {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;
            currentModalBookId = bookId;
            currentModalOrigin = origin;

            document.getElementById('modalTitle').innerText = book.title;
            document.getElementById('modalImg').src = book.src;
            document.getElementById('modalLexile').innerText = `Lexile: ${book.lexile} `;
            document.getElementById('modalWords').innerText = `${book.wordCount} Words`;
            document.getElementById('modalCategory').innerText = book.category;
            document.getElementById('modalSummary').innerText = book.summary;
            document.getElementById('modalKeywords').innerHTML = book.keywords.map(kw => `
                <span class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">#${kw}</span>
                    `).join('');

            updateBookmarkIcon(book.isBookmarked);

            // Dynamic Button Logic for Modal (Refined: Use explicit origin)
            const startBtn = document.getElementById('modalStartBtn');

            if (origin === 'history') {
                startBtn.innerHTML = `CONTINUE READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>`;
                startBtn.className = "w-full py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl bg-[#fbbf24] text-[#0f172a] shadow-amber-900/40";
                startBtn.onclick = startLearning;
            } else {
                startBtn.innerHTML = `START READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>`;
                startBtn.className = "w-full py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl bg-[#0f172a] text-white hover:bg-[#1e293b] shadow-amber-900/20";
                startBtn.onclick = () => {
                    const isInHistory = isHistoryMode ? mockHistory.some(h => h.id === bookId) : false;
                    const currentHeroId = FreshHero ? FreshHero.id : 'silent-stick';
                    const isCurrentHero = !isHistoryMode && bookId === currentHeroId;

                    if (!isInHistory && !isCurrentHero) {
                        addBookWithAnimation(bookId);
                    } else {
                        startLearning();
                    }
                };
            }

            const modal = document.getElementById('bookModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function closeModal() {
            const modal = document.getElementById('bookModal');
            const content = document.getElementById('modalContent');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            document.body.style.overflow = 'auto';
        }

        function playWhoosh() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                if (context.state === 'suspended') {
                    context.resume();
                }
                const oscillator = context.createOscillator();
                const gain = context.createGain();
                const filter = context.createBiquadFilter();

                oscillator.type = 'triangle';
                filter.type = 'highpass';
                filter.Q.value = 10;

                oscillator.connect(filter);
                filter.connect(gain);
                gain.connect(context.destination);

                const now = context.currentTime;
                const duration = 1.0;

                // Frequency sweep: Swish up then down
                oscillator.frequency.setValueAtTime(400, now);
                oscillator.frequency.exponentialRampToValueAtTime(1800, now + duration * 0.4);
                oscillator.frequency.exponentialRampToValueAtTime(600, now + duration);

                // Filter resonance sweep
                filter.frequency.setValueAtTime(1000, now);
                filter.frequency.exponentialRampToValueAtTime(4000, now + duration * 0.5);
                filter.frequency.exponentialRampToValueAtTime(1500, now + duration);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                oscillator.start(now);
                oscillator.stop(now + duration);
            } catch (e) {
                console.error("Audio failed:", e);
            }
        }


        function renderReadPhase() {
            const pha seContainer = document.getElementById('phaseContainer');
            if (!phaseContainer) return;

            // Set background cover from current book
            const book = booksData.find(b => b.id === currentModalBookId) || booksData.find(b => b.id === 'silent-stick') || booksData[0];
            const bgElement = document.getElementById('read-bg');
            if (bgElement && book) {
                bgElement.style.backgroundImage = `url('${book.src}')`;
            }

            if (currentReadStep === 'selection') {
                // [FIX] Background to SC01 for selection screen as per user request
                const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);
                const sc01 = filteredScenes.find(s => s.scene_no === 'SC01') || filteredScenes[0];
                if (bgElement && sc01) {
                    bgElement.style.backgroundImage = `url('${sc01.image_url}')`;
                }

                phaseContainer.innerHTML = `
                    <div class="flex-1 flex flex-col items-center justify-center p-8 animate-in fade-in zoom-in duration-500">
                        <h2 class="text-6xl font-black text-white mb-16 font-fredoka text-center drop-shadow-2xl">
                            How would you like to read?
                        </h2>
                        <div class="flex gap-12 max-w-6xl w-full mb-16 px-8">
                            <!-- E-Book Card -->
                            <button onclick="selectReadingMode('ebook')" id="card-ebook"
                                class="flex-1 group relative p-12 rounded-[48px] border-4 transition-all duration-300 ${selectedReadingMode === 'ebook' ? 'bg-sky-500/30 border-sky-400 shadow-[0_0_50px_rgba(56,189,248,0.4)] scale-105' : 'bg-white/10 border-white/20 hover:bg-white/20 hover:border-white/40'}">
                                <div class="w-28 h-28 rounded-3xl flex items-center justify-center mb-10 mx-auto transition-all ${selectedReadingMode === 'ebook' ? 'bg-white text-sky-500 shadow-xl' : 'bg-white/20 text-white group-hover:bg-white/30'} overflow-hidden">
                                    <img src="./public/UI/Ebook.png" class="w-full h-full object-contain p-4" />
                                </div>
                                <h3 class="text-4xl font-black mb-4 text-white font-fredoka">E-Book</h3>
                                <p class="text-xl font-medium text-slate-300 opacity-90 leading-relaxed">Classic reading experience with clean text.</p>
                                ${selectedReadingMode === 'ebook' ? '<div class="absolute -top-4 -right-4 w-12 h-12 bg-sky-400 rounded-full flex items-center justify-center text-white shadow-lg border-4 border-white"><i data-lucide="check" class="w-6 h-6"></i></div>' : ''}
                            </button>

                            <!-- Ani-book Card -->
                            <button onclick="selectReadingMode('interactive')" id="card-interactive"
                                class="flex-1 group relative p-12 rounded-[48px] border-4 transition-all duration-300 ${selectedReadingMode === 'interactive' ? 'bg-orange-500/30 border-orange-400 shadow-[0_0_50px_rgba(251,146,60,0.4)] scale-105' : 'bg-white/10 border-white/20 hover:bg-white/20 hover:border-white/40'}">
                                <div class="w-28 h-28 rounded-3xl flex items-center justify-center mb-10 mx-auto transition-all ${selectedReadingMode === 'interactive' ? 'bg-white text-orange-500 shadow-xl' : 'bg-white/20 text-white group-hover:bg-white/30'} overflow-hidden">
                                    <img src="./public/UI/Anibook.png" class="w-full h-full object-contain p-4" />
                                </div>
                                <h3 class="text-4xl font-black mb-4 text-white font-fredoka">Ani-book</h3>
                                <p class="text-xl font-medium text-slate-300 opacity-90 leading-relaxed">Read along with voice, images, and fun effects!</p>
                                ${selectedReadingMode === 'interactive' ? '<div class="absolute -top-4 -right-4 w-12 h-12 bg-orange-400 rounded-full flex items-center justify-center text-white shadow-lg border-4 border-white"><i data-lucide="check" class="w-6 h-6"></i></div>' : ''}
                            </button>
                        </div>

                        <button onclick="goToReadStep('intro')" ${!selectedReadingMode ? 'disabled' : ''} 
                            class="w-full max-w-xl h-24 bg-white text-slate-900 rounded-[32px] text-4xl font-black shadow-2xl hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-30 disabled:pointer-events-none drop-shadow-2xl">
                            OK
                        </button>
                    </div>
                `;
                lucide.createIcons();
            } else if (currentReadStep === 'intro') {
                const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);
                const scene = filteredScenes[0] || mockScenes[0];

                phaseContainer.innerHTML = `
                    <div class="relative flex-1 flex flex-col animate-in fade-in duration-500 overflow-hidden">
                        <div class="absolute inset-0">
                            <img src="${scene.image_url}" alt="scene-bg" class="w-full h-full object-cover" />
                        </div>
                        <div class="absolute top-20 left-1/2 -translate-x-1/2 px-16 py-6 bg-white/70 backdrop-blur-md rounded-[32px] shadow-2xl border-4 border-white/20">
                            <h1 class="text-7xl font-black text-slate-900 font-fredoka tracking-tight">${book.title}</h1>
                        </div>
                        <div class="absolute bottom-12 left-12 w-[580px] bg-white/70 backdrop-blur-md rounded-[48px] shadow-2xl p-12 flex flex-col gap-6 border-4 border-white/30">
                            <div class="flex gap-4">
                                <span class="px-5 py-2 bg-white rounded-2xl text-slate-900 font-black text-xl border-2 border-slate-200 uppercase tracking-tight">${selectedReadingMode}</span>
                                <span class="px-5 py-2 bg-white rounded-2xl text-slate-900 font-black text-xl border-2 border-slate-200 uppercase tracking-tight">Lexile ${book.lexile}</span>
                            </div>
                            <p class="text-slate-900 text-[2.2rem] font-black leading-tight line-clamp-2">"${scene.script.split('\n')[0].replace('"', '')}..."</p>
                            <div class="flex flex-col gap-3 mt-2">
                                <div class="flex items-center gap-3"><span class="px-4 py-1.5 bg-sky-100 text-sky-600 rounded-xl font-black text-sm uppercase">Keywords</span></div>
                                <p class="text-slate-600 font-black text-xl leading-relaxed">${book.keywords.join(', ')}</p>
                            </div>
                        </div>
                        <button onclick="goToReadStep('viewing')" class="absolute bottom-12 right-12 px-24 h-28 bg-white rounded-[40px] flex items-center justify-center text-slate-900 text-5xl font-black font-fredoka shadow-[0_30px_60px_rgba(0,0,0,0.3)] hover:scale-110 active:scale-95 transition-all border-8 border-white group">
                            START
                        </button>
                    </div>
                `;
            } else if (currentReadStep === 'viewing') {
                const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);
                const scene = filteredScenes[currentSceneIndex];
                if (!scene) return;

                // Sync background to current scene image
                if (bgElement) {
                    bgElement.style.backgroundImage = `url('${scene.image_url}')`;
                    bgElement.style.filter = 'brightness(1.0) blur(0px)';
                }

                let viewingHtml = `
                    <div class="relative flex-1 flex flex-col animate-in fade-in duration-500 overflow-hidden">
                        <!-- Scene Text Overlays -->
                        <div class="absolute inset-x-0 top-0 bottom-0 pointer-events-none z-50">
                            <div class="relative w-full h-full p-12">
                                <div class="absolute flex items-start gap-8 max-w-5xl ${getTextPositionClass(currentSceneIndex)}">
                                    <!-- Play Button (Top Left of Text) -->
                                    <button onclick="playFullSceneAudio(true)" 
                                        class="w-24 h-24 rounded-[32px] bg-[#FF6B00] text-white shadow-[0_10px_30px_rgba(255,107,0,0.4)] flex items-center justify-center hover:scale-110 active:scale-95 transition-all pointer-events-auto border-4 border-white group/play mt-2">
                                        <i data-lucide="${isSceneAudioPlaying ? 'pause' : 'play'}" class="w-12 h-12 group-hover/play:rotate-12 transition-transform fill-current"></i>
                                    </button>

                                    <div class="flex flex-col gap-4">
                                    ` + scene.script.split('\n').filter(s => s.trim()).map((sentence, sIdx) => {
                    const pClass = (textSize === 'large' ? 'text-6xl' : textSize === 'medium' ? 'text-5xl' : 'text-4xl') +
                        (playingSentenceIndex === sIdx ? ' text-orange-400' : ' text-white');

                    return `
                                        <button onclick="playSentenceAudio(${sIdx}, true)" 
                                            class="text-left font-fredoka font-black drop-shadow-2xl leading-tight transition-all hover:scale-[1.01] active:scale-95 pointer-events-auto ${pClass}">
                                            ${sentence.trim()}
                                        </button>`;
                }).join('') + `
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scene Interaction Layer -->
                        <div class="absolute inset-x-0 bottom-0 p-8 flex justify-between items-center z-60">
                            <div class="flex gap-4">
                                <button onclick="toggleSettings()" class="w-16 h-16 bg-black/40 backdrop-blur-md rounded-[24px] border-2 border-white/20 flex items-center justify-center text-white hover:bg-black/60 transition-all active:scale-95 shadow-xl">
                                    <i data-lucide="settings" class="w-8 h-8"></i>
                                </button>
                            </div>

                            <!-- Integrated SCENES Button -->
                            <button onclick="toggleScenePicker()" class="flex items-center gap-4 px-10 py-5 bg-black/50 backdrop-blur-3xl rounded-full border-2 border-white/30 hover:bg-black/70 hover:scale-105 active:scale-95 transition-all shadow-2xl group">
                                <i data-lucide="layout-grid" class="w-8 h-8 text-white group-hover:text-orange-400 transition-colors"></i>
                                <span class="text-white font-black text-2xl font-fredoka tracking-widest">
                                    SCENES <span class="text-orange-400 ml-2">${currentSceneIndex + 1} / ${filteredScenes.length}</span>
                                </span>
                            </button>

                            <div class="w-16 h-16"></div>
                        </div>

                        <!-- Navigation Buttons (Floating - Centered Vertically) -->
                        <div class="absolute inset-y-0 inset-x-12 flex items-center justify-between pointer-events-none z-60">
                            <button onclick="prevScene()" ${currentSceneIndex === 0 ? 'disabled' : ''}
                                class="w-28 h-28 bg-white/10 hover:bg-white/20 backdrop-blur-xl rounded-full border-4 border-white/20 flex items-center justify-center text-white pointer-events-auto transition-all active:scale-90 shadow-2xl ${currentSceneIndex === 0 ? 'opacity-0' : 'opacity-100'}">
                                <i data-lucide="chevron-left" class="w-16 h-16" style="stroke-width: 3"></i>
                            </button>
                            <button onclick="nextScene()"
                                class="w-28 h-28 bg-white/95 hover:bg-white rounded-full flex items-center justify-center text-slate-900 border-4 border-white pointer-events-auto transition-all active:scale-90 shadow-[0_20px_60px_rgba(0,0,0,0.5)]">
                                <i data-lucide="chevron-right" class="w-16 h-16" style="stroke-width: 3"></i>
                            </button>
                        </div>
                    </div>
                `;
                phaseContainer.innerHTML = viewingHtml;
                lucide.createIcons();
                if (!scene.fetchedScript && !scene.isFetching) {
                    scene.isFetching = true;
                    fetchSceneScript(scene).then(() => {
                        scene.isFetching = false;
                        if (currentSceneIndex === filteredScenes.indexOf(scene)) {
                            renderReadPhase();
                        }
                    });
                }
            } // end else if (currentReadStep === 'viewing')
        } // end renderReadPhase


        function exitReadPhase() {
            stopAudio();
            currentPhase = 'home';
            location.reload();
        };

        window.toggleBookmarkModal = function () {
            const book = books Data.find(b => b.id === currentModalBookId);
            if (book) {
                book.isBookmarked = !book.isBookmarked;
                updateBookmarkIcon(book.isBookmarked);
                renderBooks();
            }
        }

        function updateBookmarkIcon(isBookmarked) {
            const btn = document.getElementById('modalBookmarkBtn');
            const icon = document.getElementById('modalBookmarkIcon');
            if (isBookmarked) {
                btn.classList.remove('bg-white', 'text-slate-200');
                btn.classList.add('bg-[#FF6B00]', 'text-white');
                icon.classList.add('fill-current');
            } else {
                btn.classList.remove('bg-[#FF6B00]', 'text-white');
                btn.classList.add('bg-white', 'text-slate-200');
                icon.classList.remove('fill-current');
            }
            lucide.createIcons();
        }

        // --- 4. Navigation & Learning Transition Functions ---

        function addBookWithAnimation(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            closeModal();
            playWhoosh();

            // 1. Create Sucking Overlay & Calculate Target
            // Detect which visual slot is currently the placeholder (dashed border)
            const leftPlaceholder = document.querySelector('#hero-left-slot .border-dashed');
            const centerPlaceholder = document.querySelector('#hero-center-slot .border-dashed');
            const rightPlaceholder = document.querySelector('#hero-right-slot .border-dashed');

            let targetSlotElement = null;
            if (leftPlaceholder) targetSlotElement = document.getElementById('hero-left-slot');
            else if (centerPlaceholder) targetSlotElement = document.getElementById('hero-center-slot');
            else if (rightPlaceholder) targetSlotElement = document.getElementById('hero-right-slot');
            else targetSlotElement = document.getElementById('hero-center-slot'); // Replacement logic

            let targetLogicalIndex = 0;
            if (targetSlotElement) {
                targetLogicalIndex = parseInt(targetSlotElement.getAttribute('data-index') || '2', 10);
            }

            const targetRect = targetSlotElement ? targetSlotElement.getBoundingClientRect() : { left: window.innerWidth * 0.75, top: window.innerHeight * 0.25, width: 0, height: 0 };
            const targetX = targetRect.left + (targetRect.width / 2);
            const targetY = targetRect.top + (targetRect.height / 2);

            const overlay = document.createElement('div');
            overlay.className = 'animate-suck-to-hero rounded-[32px] overflow-hidden shadow-2xl border-4 border-white';
            overlay.style.width = '240px';
            overlay.style.height = '320px';
            overlay.style.position = 'fixed';
            overlay.style.left = '50%';
            overlay.style.top = '50%';
            overlay.style.transform = 'translate(-50%, -50%)';
            overlay.style.setProperty('--target-x', `${targetX}px`);
            overlay.style.setProperty('--target-y', `${targetY}px`);
            overlay.innerHTML = `<img src="${book.src}" class="w-full h-full object-cover">`;
            document.body.appendChild(overlay);

            // 2. Wait for animation
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }

                if (!isHistoryMode) {
                    // Fresh Mode: Replace the Hero cover
                    FreshHero = { ...book };
                    isHeroCTAFlashing = true;
                    renderHero();
                    setTimeout(() => {
                        isHeroCTAFlashing = false;
                        renderHero();
                    }, 5000);
                } else {
                    // History Mode: Fill the placeholder
                    while (mockHistory.length <= targetLogicalIndex) {
                        mockHistory.push({ id: '', src: '', title: '', phase: '', completedPhases: [], isPlaceholder: true });
                    }
                    mockHistory[targetLogicalIndex] = { ...book, progress: 0, phase: 'watch', completedPhases: [] };
                    renderHero();

                    // stage 2: Trigger smooth reordering after 200ms pause
                    setTimeout(() => {
                        // Final desired order: Left(Silent-Stick), Center(Rainbow-Cloud), Right(Milo)
                        mockHistory = [
                            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', progress: 0, phase: 'watch', completedPhases: [] },
                            { ...book, progress: 0, phase: 'watch', completedPhases: [] },
                            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', progress: 50, phase: 'quiz', completedPhases: ['watch', 'read'] }
                        ];
                        currentHeroIndex = 1; // Center the new book
                        isHeroCTAFlashing = true;
                        renderHero();

                        setTimeout(() => {
                            isHeroCTAFlashing = false;
                            renderHero();
                        }, 5000);
                    }, 200);
                }
            }, 1000);
        }

        let isGnbVisible = true;
        let gnbTimeout = null;
        let isReadUnlocked = false;


        function startLearning() {
            closeModal();
            c onst book = booksData.find(b => b.id === currentModalBookId) || booksData[0];

            // Show the overlay first
            const overlay = document.getElementById('learningModeOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('active');
            }, 10);
            document.body.style.overflow = 'hidden';

            // IMPORTANT: check history to decide phase. 
            // If progress is low or not in history, always start with Watch phase video.
            const history = mockHistory.find(h => h.id === book.id);
            const shouldStartRead = history && (history.phase === 'read' || history.completedPhases.includes('watch'));

            if (shouldStartRead) {
                    isReadUnlocked = true;
                    currentPhase = 'read';
                    currentSceneIndex = 0;
                    setPhase('read');
                }

            // Fallback to Watch phase (Default)
            document.getElementById('studyBookTitle').innerText = book.title;
            const video = document.getElementById('studyVideo');
            // Ensure path is correct and call load() to reset the player
            video.src = book.videoUrl || "./public/Video/the_silent_stick_watch.mp4";
            video.load();
            // video.play() removed as per user request (manual play required)

            setPhase('watch');
            showGnb();
            startGnbTimer();

            // Video listeners
            video.addEventListener('timeupdate', updateProgressBar);
            video.addEventListener('error', (e) => {
                console.error("Video Error:", video.error);
                alert("Video Failed to Load: " + video.src + "\nError Code: " + (video.error ? video.error.code : 'unknown'));
            });
            video.addEventListener('play', () => {
                document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
                lucide.createIcons();
            });
            video.addEventListener('pause', () => {
                document.getElementById('playIcon').setAttribute('data-lucide', 'play');
                lucide.createIcons();
            });
        }

        function exitLearningMode() {
            stopAudio();
            const video = document.getElementById('studyVideo');
            video.pause();
            document.getElementById('learningModeOverlay').classList.remove('active');
            setTimeout(() => {
                document.getElementById('learningModeOverlay').classList.add('hidden');
                document.body.style.overflow = 'auto';
                resetLearningMode();
            }, 600);
        }

        function resetLearningMode() {
            isReadUnlocked = false;
            currentPhase = 'watch';
            document.getElementById('tab-read').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('tab-read').innerHTML = '<i data-lucide="book-open" class="w-4 h-4"></i> Read <i data-lucide="lock" class="w-3 h-3"></i>';
            document.getElementById('nextPhaseContainer').classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            setPhase('watch');
            lucide.createIcons();
        }

        function showGnb() {
            document.getElementById('studyGnb').style.transform = 'translateY(0)';
            document.getElementById('gnbHandleIcon').setAttribute('data-lucide', 'chevron-up');
            // Show GNB background overlay if it was cl osed
             isGnbVisible = true;
            lucide.createIcons();
        }

        function hideGnb() {
            document.getElementById('studyGnb').style.transform = 'translateY(-100%)';
            document.getElementById('gnbHandleIcon').setAttribute('data-lucide', 'chevron-down');
            isGnbVisible = false;
            lucide.createIcons();
         }

        function toggleGnb(forceToggle = false) {
            if (isGnbVisible) hideGnb();
            else showGnb();
        }

        function startGnbTimer() {
            clearTimeout(gnbTimeout);
            gnbTimeout = setTimeout(() => {
                const video = document.getElemen tById('studyVideo');
                if (!video.paused) {
                    hideGnb();
                }
            }, 3000);
         }

         function handleMainClick() {
    if (currentPhase === 'watch') {
        toggleGnb();
    }
}

        function setPhase(phase) {
            stopAudio();
            if (phase === 'read' && !isReadUnlocked) return;

            currentPhase = phase;
            document.getElementById('phase-watch ').classLi st.add('hidden');
            document.getElementById('phase-read').classList.add('hidden');
            document.getE lementById(`phase-${phase}`).classList.remove('hidden');
            if (phase === 'read') renderReadPhase();

            // Update Tabs
            const tabs = ['watch', 'read'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (btn) {
                    const isUnlocked = (t === 'watch') || (t === 'read' && isReadUnlocked);
                    btn.classList.remove('bg-white', 'text-orange-500', 'shadow-sm', 'opacity-50', 'cursor-not-allowed', 'text-slate-400', 'text-slate-700');

                    if (isUnlocked) {
                        btn.classList.add('text-slate-700');
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.removeAttribute('disabled');
                        const lockIcon = btn.querySelector('[data-lucide="lock"]');
                        if (lockIcon) lockIcon.remove();
                    } else {
                        btn.classList.add('text-slate-400', 'opacity-50', 'cursor-not-allowed');
                        btn.setAttribute('disabled', 'true');
                    }

                    if (t === phase && isUnlocked) {
                        btn.classList.add('bg-white', 'text-orange-500', 'shadow-sm');
                        btn.classList.remove('text-slate-700');
                    }
                }
            });

            if (phase === 'read') {
                document.getElementById('studyVideo').pause();
            }
        }

        // --- 5. Video Phase Interaction ---

        // Video Logic
        function togglePlay() {
            const video = document.getElementById('studyVideo');
            const centralIcon = document.getElementById('centralPlayIcon');
            const playIcon = document.getElementById('playIcon');
            const overlay = document.getElementById('videoCentralOverlay');

            if (video.paused) {
                video.play();
                centralIcon.setAttribute('data-lucide', 'pause');
                playIcon.setAttribute('data-lucide', 'pause');
                overlay.classList.add('opacity-0', 'group-hover:opacity-100');
                hideGnb();
            } else {
                video.pause();
                centralIcon.setAttribute('data-lucide', 'play');
                playIcon.setAttribute('data-lucide', 'play');
                overlay.classList.remove('opacity-0', 'group-hover:opacity-100');
                showGnb();
            }
            lucide.createIcons();
        }

        function skipVideo(seconds) {
            const video = document.getElementById('studyVideo');
            video.currentTime += seconds;
        }

        function seekVideo(e) {
            const video = document.getElementById('studyVideo');
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
        }

        function updateProgressBar() {
            const video = document.getElementById('studyVideo');
            const progress = (video.currentTime / video.duration) * 100;
            document.getElementById('videoProgress').style.width = `${progress}%`;
        }

        window.cyclePlaybackRate = function () {
            const video = document.getElementById('studyVideo');
            const rates = [1, 1.5, 2, 0.5];
            let currentIdx = rates.indexOf(video.playbackRate);
            let nextIdx = (currentIdx + 1) % rates.length;
            video.playbackRate = rates[nextIdx];
             documen t.getElementById('playbackRateText').innerText = `${rates[nextIdx]} x`;
        }

        const mockBookMeta = {
            title: "The Silent Stick",
            level: 4,
            lexile: "300~350",
            word_count: 140,
            summary: "The frozen lake lay still under the winter moon. A lone boy discovered a mysterious staff that hummed with a quiet power... Join him as he uncovers the secrets of the enchanted forest.",
            keywords: ["frozen lake", "mysterious staff", "enchanted forest", "adventure"],
            cover_url: "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=2070"
        };





        function toggleSettings() {
            isSettingsOpen = !isSettingsOpen;
            const overlay = document.getElementById('settingsOverlay');
            if (isSettingsOpen) {
                overlay.classList.remove('hidden');
                updateSettingsUI();
            } else {
        overlay.classList.add('hidden');
            }
            lucide.createIcons();
        };

        function setNarration(val) {
            isNarrationOn = val;
            if (!isNarrationOn) {
                stopAudio();
                isPageTurnOn = false;
            } else {
                playFullSceneAudio(true);
            }
            updateSettingsUI();
            renderReadPhase();
        };

        function setPageTurn(val) {
            if (!isNarrationOn) return;
            isPageTurnOn = val;
            updateSettingsUI();
        };

        function setNarrationSpeed(speed) {
            narrationSpeed = speed;
            if (currentAudio) currentAudio.playbackRate = speed;
            updateSettingsUI();
        };

        function setTextSize(size) {
            textSize = size;
            updateSettingsUI();
            renderReadPhase();
        };

        function updateSettingsUI() {
            // Narration
            const nToggle = document.getElementById('narrationToggle');
            const nKnob = nToggle.querySelector('.toggle-knob');
            if (isNarrationOn) {
                nToggle.classList.remove('bg-slate-600');
                nToggle.classList.add('bg-orange-500');
                nKnob.classList.add('translate-x- 12');
                 nKnob.innerText = 'on';
            } else {
                nToggle.classList.add('bg-slate-600');
                nToggle.classList.remove('bg-orange-500');
                nKnob.classList.remove('translate-x-12');
                nKnob.innerText = 'off';
            }

            // Page Turn Row
            const ptRow = document.getElementById('pageTurnRow');
            const ptToggle = document.getElementById('pageTurnToggle');
            const ptKnob = ptToggle.querySelector('.toggle-knob');
            if (isNarrationOn) {
                ptRow.classList.remove('opacity-30', 'pointer-events-none');
            } else {
                ptRow.classList.add('opacity-30', 'pointer-events-none');
            }

            if (isPageTurnOn) {
                ptToggle.classList.remove('bg-slate-600');
                ptToggle.classList.add('bg-orange-500');
                ptKnob.classList.add('translate-x-12');
                ptKnob.innerText = 'on';
            } else {
                ptToggle.classList.add('bg-slate-600');
                ptToggle.classList.remove('bg-orange-500');
                ptKnob.classList.remove('translate-x-12');
                ptKnob.innerText = 'off';
            }

            // Narration Speed Row
            const nsRow = document.getElementById('narrationSpeedRow');
            if (isNarrationOn) nsRow.classList.remove('opacity-30', 'pointer-events-none');
            else nsRow.classList.add('opacity-30', 'pointer-events-none');

            [0.8, 1.0, 1.2].forEach(speed => {
                const btn = document.getElementById(`speed-${speed}`);
                if (btn) {
                    if (narrationSpeed === speed) {
                        btn.classList.add('bg-white', 'text-slate-900', 'shadow-xl', 'scale-105');
                        btn.classList.remove('bg-slate-700', 'text-white/60');
                    } else {
                        btn.classList.remove('bg-white', 'text-slate-900', 'shadow-xl', 'scale-105');
                        btn.classList.add('bg-slate-700', 'text-white/60');
                    }
                }
            });

            // Text Size
            ['normal', 'large', 'medium'].forEach(size => {
                const btn = document.getElementById(`size-${size}`);
                if (btn) {
                    if (textSize === size) {
                        btn.classList.add('bg-white', 'text-slate-900', 'shadow-xl', 'scale-105');
                        btn.classList.remove('bg-slate-700', 'text-white/60');
                    } else {
                        btn.classList.remove('bg-white', 'text-slate-900', 'shadow-xl', 'scale-105');
                        btn.classList.add('bg-slate-700', 'text-white/60');
                    }
                }
            });
        }

        function toggleScenePicker() {
            isScenePickerOpen = !isScenePickerOpen;
            const overlay = document.getElementById('scenePickerOverlay');
            if (isScenePickerOpen) {
                overlay.classList.remove('hidden');
                renderSceneThumbnails();
            } else {
                overlay.classList.add('hidden');
            }
            lucide.createIcons();
        };

        function renderSceneThumbnails() {
            const container = document.getElementById('sceneThumbnails');
            const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);

            container.innerHTML = filteredScenes.map((scene, idx) => `
                <button onclick="jumpToScene(${idx})" 
                    class="relative flex-shrink-0 w-72 aspect-video rounded-3xl overflow -hidden  snap-start transition-all duration-300 ${idx === currentSceneIndex ? 'ring-6 ring-orange-500 scale-105 shadow-[0_0_50px_rgba(255,107,0,0.6)] z-10' : 'opacity-50 hover:opacity-100 ring-2 ring-white/10'}">
                    <img src="${scene.image_url}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                    <div class="absolute bottom-4 left-6 text-white font-black text-xl">Scene ${String(idx + 1).padStart(2, '0')}</div>
                </button>
            `).join('');
        }

        function playFullSceneAudio(force = false) {
            if (!force && !isNarrationOn) return;
            const scenes = mockScenes.filter(s => s.id === currentModalBookId);
            const scene = scenes[currentSceneIndex];
            if (!scene || !scene.full_audio) return;

            if (currentAudio) currentAudio.pause();

            currentAudio = new Audio(scene.full_audio);
            currentAudio.playbackRate = narrationSpeed;
            isSceneAudioPlaying = true;
            playingSentenceIndex = null;

            currentAudio.play().catch(err => console.error("Audio play failed:", err));
            currentAudio.onended = () => {
                isSceneAudioPlaying = false;
                if (isPageTurnOn) {
                    if (currentSceneIndex < scenes.length - 1) {
                        setTimeout(() => { window.nextScene(); }, 1000);
                    } else {
                        showReadCompletePraise();
                    }
                }
                renderReadPhase();
            };
            renderReadPhase();
        };

        function playSentenceAudio(index, force = false) {
            if (!force && !isNarrationOn) return;
            const scenes = mockScenes.filter(s => s.id === currentModalBookId);
            const scene = scenes[currentSceneIndex];
            if (!scene || !scene.full_audio) return;

            if (currentAudio) currentAudio.pause();

            currentAudio = new Audio(scene.full_audio);
            currentAudio.playbackRate = narrationSpeed;
            playingSentenceIndex = index;
            isSceneAudioPlaying = false;

            currentAudio.play().catch(err => console.error("Sentence audio play failed:", err));
            currentAudio.onended = () => {
                playingSentenceIndex = null;
                renderReadPhase();
            };
            renderReadPhase();
        };

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            playingSentenceIndex = null;
            isSceneAudioPlaying = false;
        };

        function prevScene() {
            window.stopAudio();
            if (currentSceneIndex > 0) {
                window.stopAudio();
                currentSceneIndex--;
                isScenePickerOpen = false;
                renderReadPhase();
                if (isNarrationOn) {
                    setTimeout(() => { window.playFullSceneAudio(); }, 500);
                }
            }
        };

        function nextScene() {
                            topAudio();
            const scenes = mockScenes.filter(s => s.id === currentModalBookId);
            if (currentSceneIndex < scenes.length - 1) {
                window.stopAudio();
                currentSceneIndex++;
                if (currentSceneIndex > maxReachedSceneIndex) maxReachedSceneIndex = currentSceneIndex;
                isScenePickerOpen = false;
                renderReadPhase();
                        if (isNarrationOn) {
                    setTimeout(() => { window.playFullSceneAudio(); }, 500);
                }
            } else {
                showReadCompletePraise();
            }
        };

        function jumpToScene(index) {
            window.stopAudio();
            currentSceneIndex = index;
            isScenePickerOpen = false;
            document.getElementById('scenePickerOverlay').classList.add('hidden');
            renderReadPhase();
            if (isNarrationOn) {
                setTimeout(() => { window.playFullSceneAudio(); }, 500);
            }
        };

        async function fetchSceneScript(scene) {
            if (scene.fetchedScript) return scene.fetchedScript;
            const textUrl = scene.image_url.replace("/Image/", "/Data/").replace(".png", ".txt").replace(".jpg", ".txt");
            try {
                const res = await fetch(textUrl);
                if (res.ok) {
                    const text = await res.text();
                    if (text && !text.includes("<!DOCTYPE html>")) {
                        scene.fetchedScript = text;
                        return text;
                    }
                }
            } catch (e) {
                console.error("Fetch failed", e);
            }
            return scene.script;
        }


        function goToReadStep(step) {
            currentReadStep = step;
            if (step === 'viewing') {
                if (isNarrationOn) {
                    setTimeout(() => { window.playFullSceneAudio(); }, 500);
                }
            }
            renderReadPhase();
        };

        function selectReadingMode(mode) {
            selectedReadingMode = mode;
            if (mode === 'ebook') {
                isNarrationOn = true;
                isPageTurnOn = true;
            } else if (mode === 'interactive') {
                isNarrationOn = false;
                isPageTurnOn = false;
            }
            renderReadPhase();
        };





        // --- 8. Speak Stage & Praise Modal ---

        function showReadCompletePraise() {
            const overlay = document.createElement('div');
            overlay.id = 'readCompletePraise';
            overlay.className = 'fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center animate-in fade-in duration-500 cursor-pointer';
            overlay.onclick = () => {
                overlay.remove();
                showSpeakSelectionModal();
            };
            overlay.innerHTML = `
                <div class="relative flex flex-col items-center justify-center animate-in zoom-in-50 duration-500">
                    <!-- Glow Effect -->
                    <div class="absolute inset-0 bg-yellow-400/30 blur-[100px] rounded-full"></div>
                    
                    <!-- Praise Badge Image -->
                    <img src="./public/UI/praise_badge.png" alt="Great! Let's speak" class="w-[600px] h-auto object-contain drop-shadow-2xl relative z-10 hover:scale-105 transition-transform duration-300" />
                    
                    <p class="mt-8 text-white text-2xl font-fredoka font-bold animate-pulse">Click to continue</p>
                </div>
                `;
            document.body.appendChild(overlay);
        }

        function showSpeakSelectionModal() {
            const overlay = document.createElement('div');
            overlay.id = 'speakSelectionModal';
            overlay.className = 'fixed inset-0 z-[120] bg-black/60 backdrop-blur-md flex items-center justify-center animate-in fade-in duration-300';

            // [NEW] Default Selection Policy
            const defaults = [];
            if (mockScenes.length > 0) {
                const sc01Idx = mockScenes.findIndex(s => s.scene_no && s.scene_no.includes('SC01'));
                defaults.push(sc01Idx !== -1 ? sc01Idx : 0);
                if (mockScenes.length >= 2) {
                    const lastMinusOne = mockScenes.length - 2;
                    if (!defaults.includes(lastMinusOne)) defaults.push(lastMinusOne);
                }
            }
            selectedScenes = defaults;

            // Generate Scene Checkboxes
            const sceneGridHtml = mockScenes.map((scene, idx) => {
                const isSelected = selectedScenes.includes(idx);
                return `          <div class="relative group cursor-pointer" onclick="toggleSceneSelection(${idx})">
                <div class="aspect-video bg-slate-100 rounded-xl overflow-hidden border-4 transition-all duration-200 ${isSelected ? 'border-orange-500 ring-4 ring-orange-200' : 'border-slate-200 group-hover:border-orange-300'}" id="scene-card-${idx}">
                    <img src="${scene.image_url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />

                    <!-- Checkbox Overlay -->
                    <div class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg border-2 ${isSelected ? 'border-orange-500 bg-orange-500 text-white' : 'border-slate-300 bg-white text-transparent'}" id="scene-check-${idx}">
                        <i data-lucide="check" class="w-5 h-5 font-bold"></i>
                    </div>

                    <!-- Scene Label -->
                    <div class="absolute bottom-0 inset-x-0 bg-black/50 text-white text-center py-1 text-sm font-bold backdrop-blur-sm">
                        Scene ${idx + 1}
                    </div>
                </div>
                </div>
                `;
            }).join('');

            overlay.innerHTML = `
                <div class="bg-white rounded-[40px] p-8 w-[90%] max-w-5xl shadow-2xl animate-in slide-in-from-bottom-10 duration-500 relative">
                    <!-- Close Button -->
                    <button onclick="document.getElementById('speakSelectionModal').remove()" class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 transition-colors">
                        <i data-lucide="x" class="w-8 h-8 text-slate-400"></i>
                    </button>

                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-black text-slate-800 font-fredoka mb-2">Scenes you want to Read Aloud</h2>
                        <div class="flex items-center justify-center gap-2">
                             <label class="flex items-center gap-2 cursor-pointer select-none">
                                <div class="w-6 h-6 border-2 border-slate-300 rounded-md flex items-center justify-center transition-colors text-white" id="selectAllCheck" onclick="toggleSelectAll()">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </div>
                                <span class="text-slate-500 font-bold text-lg">All</span>
                            </label>
                        </div>
                    </div>

                    <!-- Scene Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto p-2">
                        ${sceneGridHtml}
                    </div>

                    <!-- Footer Action -->
                <div class="mt-8 flex justify-center">
                    <button id="confirmSelectBtn" onclick="confirmSpeakSelection()" class="px-16 py-4 rounded-full text-2xl font-black font-fredoka transition-all shadow-xl active:scale-95">
                        OK
                    </button>
                </div>
                </div>
                `;
            document.body.appendChild(overlay);
            updateSelectionUI();
            lucide.createIcons();
        }

        // [NEW] Selection Logic


        function toggleSceneSelection(idx) {
            const index = selectedScenes.indexOf(idx);
            const card = document.getElementById(`scene-card-${idx}`);
            const check = document.getElementById(`scene-check-${idx}`);

            if (index > -1) {
                selectedScenes.splice(index, 1);
                card.classList.remove('border-orange-500', 'ring-4', 'ring-orange-200');
                card.classList.add('border-slate-200');
                check.classList.remove('border-orange-500', 'bg-orange-500', 'text-white');
                check.classList.add('border-slate-300', 'text-transparent');
            } else {
                selectedScenes.push(idx);
                card.classList.add('border-orange-500', 'ring-4', 'ring-orange-200');
                card.classList.remove('border-slate-200');
                check.classList.add('border-orange-500', 'bg-orange-500', 'text-white');
                check.classList.remove('border-slate-300', 'text-transparent');
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const isAll = (selectedScenes.length === mockScenes.length && mockScenes.length > 0);
            if (isAll) {
                selectedScenes = [];
                mockScenes.forEach((_, i) => {
                    const card = document.getElementById(`scene-card-${i}`);
                    const check = document.getElementById(`scene-check-${i}`);
                    if (card) {
                        card.classList.remove('border-orange-500', 'ring-4', 'ring-orange-200');
                        card.classList.add('border-slate-200');
                    }
                    if (check) {
                        check.classList.remove('border-orange-500', 'bg-orange-500', 'text-white');
                        check.classList.add('border-slate-300', 'text-transparent');
                    }
                });
            } else {
                selectedScenes = mockScenes.map((_, i) => i);
                mockScenes.forEach((_, i) => {
                    const card = document.getElementById(`scene-card-${i}`);
                    const check = document.getElementById(`scene-check-${i}`);
                    if (card) {
                        card.classList.add('border-orange-500', 'ring-4', 'ring-orange-200');
                        card.classList.remove('border-slate-200');
                    }
                    if (check) {
                        check.classList.add('border-orange-500', 'bg-orange-500', 'text-white');
                        check.classList.remove('border-slate-300', 'text-transparent');
                    }
                });
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const isAll = (selectedScenes.length === mockScenes.length && mockScenes.length > 0);
            const selectAllCheck = document.getElementById('selectAllCheck');
            if (selectAllCheck) {
                if (isAll) {
                    selectAllCheck.classList.add('bg-orange-500', 'border-orange-500');
                    selectAllCheck.classList.remove('border-slate-300');
                } else {
                    selectAllCheck.classList.remove('bg-orange-500', 'border-orange-500');
                    selectAllCheck.classList.add('border-slate-300');
                }
            }

            const confirmBtn = document.getElementById('confirmSelectBtn');
            if (confirmBtn) {
                const baseClasses = "px-16 py-4 rounded-full text-2xl font-black font-fredoka transition-all shadow-xl active:scale-95";
                const disabledClasses = "bg-slate-100 border-4 border-slate-200 text-slate-300 cursor-not-allowed opacity-50";
                const enabledClasses = "bg-white border-4 border-slate-200 text-slate-700 hover:bg-orange-500 hover:text-white hover:border-orange-500 hover:shadow-orange-200";

                if (selectedScenes.length < 2) {
                    confirmBtn.disabled = true;
                    confirmBtn.className = `${baseClasses} ${disabledClasses} `;
                } else {
                    confirmBtn.disabled = false;
                    confirmBtn.className = `${baseClasses} ${enabledClasses} `;
                }
            }
        }

        function confirmSpeakSelection() {
            if (selectedScenes.length < 2) return;
            document.getElementById('speakSelectionModal').remove();

            // Unlock and Switch to Speak Mode
            if (!unlockedPhases.includes('speak')) {
                unlockedPhases.push('speak');
            }

            // Since Speak logic isn't fully implemented in this prototype, 
            // we'll simulate the switch by unlocking and updating the UI
            isReadUnlocked = true; // Ensure Read remains unlocked

            // Visual update for GNB
            const speakBtn = document.querySelector('button[onclick="setPhase(\'speak\')"]');
            if (speakBtn) {
                speakBtn.removeAttribute('disabled');
                speakBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'text-slate-400');
                speakBtn.classList.add('text-slate-700');
                speakBtn.click(); // Trigger phase switch
            } else {
                setPhase('speak'); // Fallback
            }
        }


        function onVideoEnded() {
            document.getElementById('nextPhaseContainer').classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            document.getElementById('nextPhaseContainer').innerHTML = `
                <button onclick="isReadUnlocked=true; currentReadStep='selection'; setPhase('read'); renderReadPhase();"
            class="px-12 py-6 bg-white rounded-full font-black text-slate-900 text-3xl shadow-[0_20px_50px_rgba(0,0,0,0.3)] hover:scale-110 active:scale-95 transition-all flex items-center gap-4 border-8 border-white group">
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-slate-400 text-xs font-black uppercase tracking-widest mb-1">Great Watching!</span>
                        <span class="font-fredoka uppercase text-4xl">Read Next</span>
                    </div>
                    <div class="w-14 h-14 bg-[#FF6B00] rounded-2xl flex items-center justify-center text-white group-hover:rotate-12 transition-transform shadow-lg">
                        <i data-lucide="chevron-right" class="w-10 h-10"></i>
                    </div>
                </button>
            `;
            lucide.createIcons();

            document.getElementById('centralPlayIcon').setAttribute('data-lucide', 'play');
            document.getElementById('playIcon').setAttribute('data-lucide', 'play');
            lucide.createIcons();
        }


        const bookContainer = document.getElementById('bookContainer');
        const scrollLeftBtn = document.getElementById('scrollLeftBtn');

        function scrollContainer(amount) {
            bookContainer.scrollBy({
                left: amount,
                behavior: 'smooth'
            });
        }

        bookContainer.addEventListener('scroll', () => {
            if (bookContainer.scrollLeft > 10) {
                scrollLeftBtn.classList.remove('invisible', 'opacity-0');
                scrollLeftBtn.classList.add('opacity-100');
            } else {
                scrollLeftBtn.classList.add('invisible', 'opacity-0');
                scrollLeftBtn.classList.remove('opacity-100');
            }
        });

        // Swipe / Drag Scroll Logic
        let isDown = false;
        let startX;
        let scrollLeftPos;

        bookContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            bookContainer.classList.remove('scroll-smooth');
            startX = e.pageX - bookContainer.offsetLeft;
            scrollLeftPos = bookContainer.scrollLeft;
        });

        bookContainer.addEventListener('mouseleave', () => {
            isDown = false;
        });

        bookContainer.addEventListener('mouseup', () => {
            isDown = false;
            bookContainer.classList.add('scroll-smooth');
        });

        bookContainer.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - bookContainer.offsetLeft;
            const walk = (x - startX) * 2;
            bookContainer.scrollLeft = scrollLeftPos - walk;
        });

        renderBooks();
        renderHero();
        lucide.createIcons();
    </script>
</body>

</html>