<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Reading Adventure - Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Jua&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --font-fredoka: 'Fredoka', sans-serif;
            --font-jua: 'Jua', sans-serif;
        }

        body {
            font-family: var(--font-fredoka);
            background: linear-gradient(to bottom, #FEFCE8, #EFF6FF);
            /* yellow-50 to blue-50 */
            color: #334155;
            min-height: 100vh;
        }

        .font-jua {
            font-family: var(--font-jua);
        }

        .btn-jelly {
            border-radius: 9999px;
            border-width: 4px;
            border-color: #334155;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-jelly:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
        }

        .card-bubble {
            border-radius: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-width: 6px;
            border-color: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 10px;
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #FFEDD5;
            /* orange-100 */
            border-radius: 9999px;
            border: 3px solid transparent;
            background-clip: padding-box;
            transition: background-color 0.3s;
        }

        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background-color: #FED7AA;
            /* orange-200 */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #FDBA74;
            /* orange-300 */
        }

        .animate-twinkle {
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
                filter: brightness(1.3);
                drop-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            }
        }

        #learningModeOverlay {
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%);
            background-color: #000000;
        }

        #learningModeOverlay.active {
            transform: translateY(0);
        }

        #studyGnb {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        #gnbHandle {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-suck-to-hero {
            animation: suck-to-hero 1.0s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes suck-to-hero {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                left: 50%;
                top: 50%;
            }

            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(-5deg);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.1) rotate(25deg);
                left: var(--target-x, 75%);
                top: var(--target-y, 25%);
            }
        }

        @keyframes flash-yellow {

            0%,
            100% {
                filter: brightness(1) contrast(1);
                transform: scale(1);
            }

            50% {
                filter: brightness(1.2) contrast(1.1);
                transform: scale(1.02);
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
            }
        }

        .animate-flash-yellow {
            animation: flash-yellow 1s infinite;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-12">
        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-6">
                <div
                    class="w-16 h-16 bg-yellow-300 rounded-full border-[6px] border-white shadow-xl flex items-center justify-center overflow-hidden transform hover:scale-110 transition-transform">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Ami" alt="User Avatar">
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-700 tracking-tight font-jua">Ami's Adventure</h1>
                    <div
                        class="flex items-center gap-2 text-green-500 text-sm font-bold bg-green-50 px-3 py-1 rounded-full w-fit mt-1">
                        <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></span>
                        Ready to Learn!
                    </div>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <button id="modeToggleBtn" onclick="toggleMode()"
                    class="px-6 py-3 rounded-2xl text-sm font-black transition-all border-[3px] shadow-sm bg-sky-500 text-white border-sky-400 shadow-sky-100 hover:scale-105 active:scale-95">
                    HISTORY MODE
                </button>
                <button
                    class="w-14 h-14 bg-white rounded-3xl shadow-lg flex items-center justify-center text-slate-400 hover:text-orange-500 transition-all border-4 border-white active:scale-95"><i
                        data-lucide="bell" class="w-7 h-7"></i></button>
                <button
                    class="w-14 h-14 bg-white rounded-3xl shadow-lg flex items-center justify-center text-slate-400 hover:text-orange-500 transition-all border-4 border-white active:scale-95"><i
                        data-lucide="menu" class="w-7 h-7"></i></button>
            </div>
        </header>

        <!-- Hero Section -->
        <!-- Hero Section Container -->
        <div id="heroContainer">
            <!-- Will be rendered by script -->
        </div>

        <!-- Library Section -->
        <div class="card-bubble p-8 md:p-10 w-full relative">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-4xl font-black text-slate-700 flex items-center gap-5 font-jua">
                    <span
                        class="w-14 h-14 bg-sky-100 rounded-[20px] flex items-center justify-center text-sky-400 shadow-sm shadow-sky-100 transform rotate-3">
                        <i data-lucide="sparkles" class="w-9 h-9 fill-current"></i>
                    </span>
                    Recommended for Ami
                </h3>
                <a href="#"
                    class="px-6 py-4 bg-sky-50 text-sky-400 font-black btn-jelly text-sm flex items-center gap-3 hover:bg-sky-100 group">
                    SEE ALL <i data-lucide="chevron-right"
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>

            <div class="relative group/scroll px-4">
                <!-- Bookshelf Base -->
                <div
                    class="absolute bottom-10 left-0 right-0 h-16 bg-slate-200/40 rounded-full mx-6 border-b-4 border-slate-300/20">
                </div>

                <button id="scrollLeftBtn" onclick="scrollContainer(-400)"
                    class="absolute left-0 top-[35%] -translate-y-1/2 -translate-x-6 w-14 h-14 bg-white text-sky-400 rounded-full shadow-lg border border-slate-100 flex items-center justify-center z-20 opacity-0 group-hover/scroll:opacity-100 transition-all hover:bg-sky-50 active:scale-90 invisible">
                    <i data-lucide="chevron-left" class="w-9 h-9"></i>
                </button>

                <div id="bookContainer"
                    class="flex gap-4 md:gap-6 overflow-x-auto pt-10 pb-12 scroll-smooth custom-scrollbar relative z-10 cursor-grab active:cursor-grabbing select-none">
                    <!-- Books will be injected by script -->
                </div>

                <button onclick="scrollContainer(400)"
                    class="absolute right-0 top-[35%] -translate-y-1/2 translate-x-6 w-14 h-14 bg-white text-sky-400 rounded-full shadow-lg border border-slate-100 flex items-center justify-center z-20 opacity-0 group-hover/scroll:opacity-100 transition-all hover:bg-sky-50 active:scale-90">
                    <i data-lucide="chevron-right" class="w-9 h-9"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="bookModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="card-bubble w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col relative z-10 scale-95 opacity-0 transition-all duration-300"
            id="modalContent">
            <!-- Bookmark Ribbon - Stuck to Top -->
            <div class="absolute top-0 left-12 z-20 pointer-events-none">
                <button onclick="toggleBookmarkModal()" id="modalBookmarkBtn"
                    class="w-16 h-24 flex items-center justify-center pt-2 pb-8 transition-all pointer-events-auto active:scale-95 shadow-xl rounded-b-3xl border-[6px] border-t-0 border-white bg-white text-slate-200">
                    <i data-lucide="bookmark" id="modalBookmarkIcon" class="w-10 h-10"></i>
                </button>
            </div>

            <!-- Modal Header -->
            <div class="p-6 md:p-8 flex justify-between items-center border-b-[6px] border-slate-50">
                <div class="w-16"></div> <!-- Spacer for ribbon -->
                <h2 id="modalTitle"
                    class="text-3xl md:text-4xl font-black text-slate-700 font-jua text-center flex-1 mx-4 truncate">
                    Book Title
                </h2>
                <button onclick="closeModal()"
                    class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 md:p-10">
                <div class="flex flex-col md:flex-row gap-10">
                    <div class="w-full md:w-1/2 flex-shrink-0">
                        <div
                            class="aspect-[3/4] rounded-[48px] overflow-hidden border-[8px] border-white shadow-2xl shadow-slate-200">
                            <img id="modalImg" src="" alt="" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 space-y-8">
                        <div class="flex flex-wrap gap-3">
                            <span id="modalLexile"
                                class="px-5 py-2 bg-orange-100 text-orange-500 rounded-full font-black text-sm border-2 border-orange-200">Lexile:
                                300</span>
                            <span id="modalWords"
                                class="px-5 py-2 bg-green-100 text-green-500 rounded-full font-black text-sm border-2 border-green-200">140
                                Words</span>
                            <span id="modalCategory"
                                class="px-5 py-2 bg-sky-100 text-sky-500 rounded-full font-black text-sm border-2 border-sky-200">Science</span>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xl font-black text-slate-800 font-jua">Summary</h4>
                            <p id="modalSummary" class="text-lg text-slate-600 leading-relaxed font-fredoka">Summary
                                goes here...</p>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xl font-black text-slate-800 font-jua">Keywords</h4>
                            <div id="modalKeywords" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-8 md:p-10 bg-slate-50/50 flex justify-center">
                <button onclick="startLearning()" id="modalStartBtn"
                    class="w-full md:max-w-md py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl">
                    START READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Mode Overlay -->
    <div id="learningModeOverlay"
        class="fixed inset-0 z-[100] bg-black hidden overflow-hidden shadow-[0_-20px_50px_rgba(0,0,0,0.3)]">
        <!-- Floating GNB Wrapper -->
        <div id="gnbWrapper" class="fixed top-0 inset-x-0 z-[110]">
            <nav id="studyGnb"
                class="h-24 px-8 flex items-center justify-between shadow-xl border-b-2 border-slate-100">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-500 shadow-inner">
                        <i data-lucide="video" class="w-7 h-7 fill-current"></i>
                    </div>
                    <h2 id="studyBookTitle" class="text-2xl font-black text-slate-700 font-jua">Book Title</h2>
                </div>

                <!-- Phase Tabs -->
                <div class="flex bg-slate-100 p-1.5 rounded-2xl gap-1">
                    <button id="tab-watch" onclick="setPhase('watch')"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 bg-white text-orange-500 shadow-sm">
                        <i data-lucide="play-circle" class="w-4 h-4 fill-current"></i> Watch
                    </button>
                    <button id="tab-read" onclick="setPhase('read')"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="book-open" class="w-4 h-4"></i> Read <i data-lucide="lock" class="w-3 h-3"></i>
                    </button>
                    <button id="tab-quiz"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="help-circle" class="w-4 h-4"></i> Quiz <i data-lucide="lock"
                            class="w-3 h-3"></i>
                    </button>
                    <button id="tab-talk"
                        class="px-6 py-2.5 rounded-xl font-black text-sm transition-all flex items-center gap-2 text-slate-400 opacity-50 cursor-not-allowed">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> Talk <i data-lucide="lock"
                            class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="w-48 flex justify-end">
                    <button id="gnbCloseBtn" onclick="exitLearningMode()"
                        class="w-14 h-14 bg-slate-50 rounded-2xl border-4 border-white flex items-center justify-center text-slate-400 shadow-sm hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-all active:scale-95 group">
                        <i data-lucide="x" class="w-8 h-8 group-hover:rotate-90 transition-transform"></i>
                    </button>
                </div>

                <!-- The Handle (Sticky to top when GNB hides) -->
                <button id="gnbHandle" onclick="toggleGnb(true); event.stopPropagation();"
                    class="absolute -bottom-10 left-1/2 -translate-x-1/2 w-24 h-10 bg-white border-b-4 border-x-4 border-slate-50 rounded-b-[32px] flex items-center justify-center text-slate-300 hover:text-sky-400 shadow-lg transition-all active:h-12 pointer-events-auto">
                    <i data-lucide="chevron-up" id="gnbHandleIcon" class="w-8 h-8"></i>
                </button>
            </nav>
        </div>

        <!-- Study Content Area -->
        <main id="mainContent" class="w-full h-full bg-black flex items-center justify-center relative cursor-pointer"
            onclick="handleMainClick()">
            <!-- Watch Phase -->
            <div id="phase-watch" class="w-full h-full flex items-center justify-center p-4">
                <div
                    class="w-full h-full max-w-screen-2xl min-h-[60vh] bg-black rounded-[24px] overflow-hidden relative group">
                    <video id="studyVideo" class="w-full h-full object-contain pointer-events-auto"
                        onplay="document.getElementById('nextPhaseContainer').classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');"
                        onended="onVideoEnded()" src="public/video/Intro.mp4"></video>

                    <!-- Custom Video Controls -->
                    <div id="videoControls"
                        class="absolute bottom-0 inset-x-0 h-24 bg-gradient-to-t from-black/80 to-transparent flex items-center px-10 gap-8 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button onclick="togglePlay()" class="text-white hover:scale-110 transition-transform">
                            <i data-lucide="play" id="playIcon" class="w-10 h-10 fill-current"></i>
                        </button>

                        <div class="flex items-center gap-4">
                            <button onclick="skipVideo(-3)" class="text-white/80 hover:text-white transition-colors">
                                <i data-lucide="rotate-ccw" class="w-7 h-7"></i>
                            </button>
                            <button onclick="skipVideo(3)" class="text-white/80 hover:text-white transition-colors">
                                <i data-lucide="rotate-cw" class="w-7 h-7"></i>
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div class="flex-1 h-2 bg-white/20 rounded-full overflow-hidden cursor-pointer relative"
                            onclick="seekVideo(event)">
                            <div id="videoProgress" class="absolute inset-y-0 left-0 bg-sky-400 rounded-full w-0"></div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="cyclePlaybackRate()"
                                class="px-4 py-1.5 bg-white/10 text-white rounded-xl text-sm font-black border border-white/20 hover:bg-white/20">
                                <span id="playbackRateText">1.0x</span>
                            </button>
                        </div>
                    </div>

                    <!-- Next Button (hidden initially) -->
                    <div id="nextPhaseContainer"
                        class="absolute bottom-12 right-12 transition-all duration-500 transform translate-y-10 opacity-0 pointer-events-none z-30">
                        <button onclick="setPhase('read')"
                            class="px-10 py-5 bg-[#FF6B00] text-white rounded-3xl font-black text-xl flex items-center gap-3 shadow-2xl animate-twinkle hover:scale-105 active:scale-95 transition-all">
                            Read Next <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Big Play/Pause Button Overlay (YouTube Style) -->
                    <div id="videoCentralOverlay"
                        class="absolute inset-0 bg-black/20 flex items-center justify-center z-20 transition-all duration-300 pointer-events-none">
                        <button onclick="togglePlay(); event.stopPropagation();"
                            class="w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/30 shadow-2xl hover:scale-110 active:scale-95 transition-all group pointer-events-auto">
                            <i data-lucide="play" id="centralPlayIcon" class="w-16 h-16 fill-current"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Read Phase - 3 Steps Flow -->
            <div id="phase-read" class="w-full h-full flex flex-col relative overflow-hidden hidden">
                <!-- Background Layer: Cover Image (Darkened) -->
                <div id="read-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-1000"
                    style="filter: brightness(0.3) blur(8px)">
                </div>

                <!-- Step 1: Mode Selection -->
                <div id="read-step-selection"
                    class="relative z-10 flex-1 flex flex-col items-center justify-center p-8 animate-in fade-in zoom-in duration-500">
                    <h2 class="text-5xl font-black text-white mb-12 font-jua text-center drop-shadow-2xl">
                        How would you like to read?
                    </h2>
                    <div class="flex gap-8 max-w-5xl w-full">
                        <!-- E-Book Card -->
                        <button onclick="selectReadingMode('ebook')" id="card-ebook"
                            class="flex-1 group relative p-10 rounded-[40px] border-4 transition-all duration-300 bg-white/10 border-white/20 hover:bg-white/20">
                            <div
                                class="w-24 h-24 rounded-3xl flex items-center justify-center mb-8 mx-auto transition-colors bg-white/20 text-white">
                                <i data-lucide="book" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-3xl font-black mb-4 text-white">E-Book</h3>
                            <p class="text-lg font-medium opacity-80 text-slate-300">Classic reading experience with
                                clean text.</p>
                        </button>

                        <!-- Interactive Card -->
                        <button onclick="selectReadingMode('interactive')" id="card-interactive"
                            class="flex-1 group relative p-10 rounded-[40px] border-4 transition-all duration-300 bg-white/10 border-white/20 hover:bg-white/20">
                            <div
                                class="w-24 h-24 rounded-3xl flex items-center justify-center mb-8 mx-auto transition-colors bg-white/20 text-white">
                                <i data-lucide="sparkles" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-3xl font-black mb-4 text-white">Interactive</h3>
                            <p class="text-lg font-medium opacity-80 text-slate-300">Read along with voice, images, and
                                fun effects!</p>
                        </button>
                    </div>

                    <button id="modeOkBtn" disabled onclick="goToReadStep('intro')"
                        class="mt-16 px-16 py-6 rounded-3xl font-black text-3xl transition-all bg-slate-700 text-slate-500 cursor-not-allowed">
                        OK
                    </button>
                </div>

                <!-- Step 2: Book Intro -->
                <div id="read-step-intro"
                    class="relative z-10 flex-1 flex flex-col items-center justify-between p-16 hidden">
                    <div class="w-full max-w-6xl flex flex-col items-center gap-6">
                        <div id="intro-level"
                            class="px-6 py-2 bg-sky-500 text-white rounded-full font-black text-xl shadow-lg">Level 4
                        </div>
                        <h2 id="intro-title"
                            class="text-7xl font-black text-white text-center font-jua drop-shadow-2xl">Book Title</h2>
                    </div>

                    <div class="w-full max-w-7xl flex items-end justify-between gap-12">
                        <div
                            class="flex-1 bg-black/60 backdrop-blur-xl p-12 rounded-[48px] border-2 border-white/10 flex flex-col gap-8 shadow-2xl text-left">
                            <div class="flex gap-12 text-white">
                                <div class="flex flex-col gap-1">
                                    <span class="text-sky-300 text-sm font-bold uppercase tracking-widest">Lexile</span>
                                    <span id="intro-lexile" class="text-3xl font-black tracking-tight">300~350</span>
                                </div>
                                <div class="w-px h-12 bg-white/20"></div>
                                <div class="flex flex-col gap-1">
                                    <span class="text-sky-300 text-sm font-bold uppercase tracking-widest">Words</span>
                                    <span id="intro-words" class="text-3xl font-black tracking-tight">140</span>
                                </div>
                            </div>
                            <p id="intro-summary" class="text-2xl text-slate-100 font-medium leading-[1.6]">
                                Summary...
                            </p>
                            <div id="intro-keywords" class="flex flex-wrap gap-3"></div>
                        </div>

                        <button onclick="goToReadStep('viewing')"
                            class="w-48 h-48 bg-white text-slate-900 rounded-full flex items-center justify-center font-black text-4xl shadow-2xl hover:scale-110 active:scale-95 transition-all animate-twinkle">
                            START
                        </button>
                    </div>
                </div>

                <!-- Step 3: Reading Viewer -->
                <div id="read-step-viewing" class="relative z-10 flex-1 flex flex-col p-8 hidden">
                    <div class="flex-1 flex gap-8 max-w-[1600px] mx-auto w-full">
                        <!-- Left: Image Panel -->
                        <div
                            class="flex-[1.2] rounded-[48px] overflow-hidden shadow-2xl bg-white/5 border border-white/10 relative">
                            <img id="viewing-img" src="" alt="scene" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent">
                            </div>
                            <div id="viewing-scene-no"
                                class="absolute bottom-8 left-8 px-6 py-2 bg-black/40 backdrop-blur-md rounded-2xl text-white font-black">
                                #SC01
                            </div>
                        </div>

                        <!-- Right: Text Panel -->
                        <div class="flex-1 flex flex-col gap-6">
                            <div
                                class="flex-1 bg-white rounded-[48px] shadow-2xl p-16 flex flex-col justify-center gap-12 text-left">
                                <p id="viewing-script"
                                    class="text-5xl font-bold text-slate-800 leading-[1.4] tracking-tight">
                                    Script...
                                </p>
                                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="viewing-progress" class="h-full bg-sky-500 transition-all duration-500"
                                        style="width: 33%"></div>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="flex gap-4">
                                <button id="prevBtn" onclick="changeScene(-1)"
                                    class="flex-1 h-32 rounded-[32px] border-4 flex items-center justify-center transition-all bg-white/10 border-white/20 text-white hover:bg-white/20 active:scale-95">
                                    <i data-lucide="chevron-left" class="w-12 h-12"></i>
                                </button>
                                <button id="nextBtn" onclick="changeScene(1)"
                                    class="flex-[2] h-32 bg-white text-slate-900 rounded-[32px] flex items-center justify-center font-black text-3xl shadow-xl hover:scale-105 active:scale-95 transition-all">
                                    <span id="nextBtnText" class="flex items-center gap-4">Next Scene <i
                                            data-lucide="chevron-right" class="w-8 h-8"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const booksData = [
            { id: 'missing-planet', title: 'The Missing Planet', src: './public/Image/Cover/The Missing Planet.png', lexile: '250~300', wordCount: 120, category: 'Space ðŸš€', summary: 'A brave little astronaut goes on a mission to find a planet that disappeared from the star maps. Join the cosmic adventure!', keywords: ['planet', 'space', 'astronaut', 'star'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'rainbow', title: 'Rainbow', src: './public/Image/Cover/Rainbow.png', lexile: '150~200', wordCount: 85, category: 'Nature ðŸŒˆ', summary: 'Follow the beautiful colors across the sky after a rainy day. Learn how rainbows are made of light and magic!', keywords: ['color', 'rain', 'sky', 'sun'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'two-friends', title: 'Two Friends', src: './public/Image/Cover/Two Friends.png', lexile: '200~250', wordCount: 110, category: 'Friendship ðŸ¤', summary: 'A story about a rabbit and a turtle who discover that being different is what makes their friendship so special.', keywords: ['friends', 'together', 'help', 'game'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'silent-seed', title: 'The Silent Seed', src: './public/Image/Cover/The Silent Seed.png', lexile: '300~350', wordCount: 145, category: 'Science ðŸ”¬', summary: 'Deep under the ground, a tiny seed waits silently for the perfect moment to grow into a magnificent tree.', keywords: ['grow', 'wait', 'ground', 'leaf'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', lexile: '250~320', wordCount: 130, category: 'Adventure ðŸ—ºï¸', summary: 'A magic stick that doesn\'t make a sound helps a quiet boy find his way through a mysterious forest.', keywords: ['magic', 'quiet', 'forest', 'path'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'broken-branch', title: 'The Broken Branch', src: './public/Image/Cover/The Broken Branch.png', lexile: '280~340', wordCount: 135, category: 'Nature ðŸŒ³', summary: 'When a strong wind breaks a branch, the forest animals work together to make it a new home for a bird family.', keywords: ['tree', 'wind', 'home', 'birds'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'pea', title: 'The Pea', src: './public/Image/Cover/The Pea.png', lexile: '180~230', wordCount: 95, category: 'Food ðŸ«›', summary: 'One tiny green pea rolls off the plate and travels across the kitchen floor. Where will it end up?', keywords: ['green', 'roll', 'kitchen', 'floor'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', lexile: '320~380', wordCount: 160, category: 'Animals ðŸ¶', summary: 'Milo is a dog with a very big imagination. Every time he goes for a walk, he sees a world full of dragons.', keywords: ['dog', 'dream', 'adventure', 'wild'], isBookmarked: false, videoUrl: './public/Video/milo_and_the_lost_color_watch.mp4' },
            { id: 'rainbow-cloud', title: 'Rainbow Cloud', src: './public/Image/Cover/The Rainbow Cloud.png', lexile: '350~400', wordCount: 180, category: 'Fantasy âœ¨', summary: 'A magical cloud that rains colors instead of water changes everything in the gray city of Grumbletown.', keywords: ['magic', 'cloud', 'color', 'happy'], isBookmarked: true, videoUrl: './public/Video/rainbow_cloud_watch.mp4' },
            { id: 'cindellar', title: 'Cindellar', src: './public/Image/Cover/Cindellar.png', lexile: '380~450', wordCount: 210, category: 'Classic ðŸ°', summary: 'A new retelling of the classic fairy tale with a focus on being kind to yourself and others.', keywords: ['princess', 'kind', 'dance', 'shoe'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'flying-trunk', title: 'The Flying Trunk', src: './public/Image/Cover/The Fyling Trunk.png', lexile: '340~390', wordCount: 175, category: 'Adventure ðŸ—ºï¸', summary: 'Travel the world in a magic trunk that can fly over mountains and oceans.', keywords: ['fly', 'travel', 'ocean', 'magic'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'rapunzel', title: 'The Rapunzel', src: './public/Image/Cover/The Rapunzel.png', lexile: '360~410', wordCount: 190, category: 'Classic ðŸ°', summary: 'A story about inner strength and finding your own voice from high up in a stone tower.', keywords: ['hair', 'tower', 'voice', 'strong'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
            { id: 'ugly-dukling', title: 'The Ugly Dukling', src: './public/Image/Cover/The Ugly Dukling.png', lexile: '300~360', wordCount: 155, category: 'Animals Swan', summary: 'Discover how being different can lead to finding where you truly belong.', keywords: ['different', 'belong', 'lake', 'swan'], isBookmarked: false, videoUrl: './public/Video/the_silent_stick_watch.mp4' },
        ];

        let currentModalBookId = null;
        let isHistoryMode = true;
        let freshHeroBook = null;
        let currentHeroIndex = 1; // Start with Silent Stick in middle
        let isHeroCTAFlashing = false;
        let currentModalOrigin = 'recommendation';

        let mockHistory = [
            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', progress: 50, phase: 'quiz', completedPhases: ['watch', 'read'] },
            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', progress: 0, phase: 'watch', completedPhases: [] },
            { id: 'empty-placeholder', title: '', src: '', progress: 0, phase: '', completedPhases: [], isPlaceholder: true }
        ];

        let currentPhase = 'home'; // 'home' or 'read'
        let currentSceneIndex = 0;
        let selectedReadingMode = 'ebook';
        const scenesData = [
            { book_id: "silent-stick", scene_no: "SC01", script: "The frozen lake lay still, a big area of gray ice beneath a heavy winter sky.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png" },
            { book_id: "silent-stick", scene_no: "SC02", script: "He hit the puck with force, but his old stick broke suddenly upon impact.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.png" },
            { book_id: "silent-stick", scene_no: "SC03", script: "Two pieces of wood lay on the ice, showing the end of his practice.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC03.png" },
            { book_id: "silent-stick", scene_no: "SC04", script: "Ren worked for hours, cutting the skin to show the hard wood under.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC04.png" },
            { book_id: "silent-stick", scene_no: "SC05", script: "When he tested it, the puck flew in strange circles due to the woodâ€™s natural shape.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC05.png" },
            { book_id: "silent-stick", scene_no: "SC06", script: "Jax glanced at Renâ€™s rough branch and offered a cold smile, saying nothing.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC06.png" },
            { book_id: "silent-stick", scene_no: "SC07", script: "Jax controlled the ice, his speed pushing Ren back toward his own goal.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC07.png" },
            { book_id: "silent-stick", scene_no: "SC08", script: "The puck turned around the confused player, going quietly into the net as the whistle blew.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC08.png" },
            { book_id: "silent-stick", scene_no: "SC09", script: "Ren smiled at his rough stick and skated away silently.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC09.png" }
        ];

        function toggleMode() {
            isHistoryMode = !isHistoryMode;
            currentHeroIndex = 0;
            const btn = document.getElementById('modeToggleBtn');
            if (isHistoryMode) {
                btn.innerText = 'HISTORY MODE';
                btn.classList.remove('bg-white', 'text-slate-400', 'border-slate-100');
                btn.classList.add('bg-sky-500', 'text-white', 'border-sky-400', 'shadow-sky-100');
            } else {
                btn.innerText = 'FRESH MODE';
                btn.classList.add('bg-white', 'text-slate-400', 'border-slate-100');
                btn.classList.remove('bg-sky-500', 'text-white', 'border-sky-400', 'shadow-sky-100');
            }
            renderHero();
        }

        function renderHero() {
            const container = document.getElementById('heroContainer');
            const isHistory = isHistoryMode;
            const items = isHistory ? mockHistory : [
                freshHeroBook || booksData.find(b => b.id === 'silent-stick')
            ];

            const userName = "Ami";
            const safeIndex = currentHeroIndex >= items.length ? 0 : currentHeroIndex; // lint: Ensure index is within bounds.
            const item = items[safeIndex];
            if (item) currentModalBookId = item.id; // lint: Safely set currentModalBookId.
            const prevItem = items[(currentHeroIndex - 1 + items.length) % items.length];
            const nextItem = items[(currentHeroIndex + 1) % items.length];

            const progress = (isHistory && !item.isPlaceholder) ? item.progress : 0;
            const phasesText = (isHistory && !item.isPlaceholder) ? `
                <div class="flex gap-3 mb-1">
                    <span class="text-xs uppercase ${item.completedPhases.includes('watch') ? 'text-green-400' : 'text-yellow-300 font-black'}">watch</span>
                    <span class="text-xs uppercase ${item.phase === 'read' ? 'text-yellow-300 font-black' : item.completedPhases.includes('read') ? 'text-green-400' : 'opacity-40'}">> read</span>
                    <span class="text-xs uppercase ${item.phase === 'quiz' ? 'text-yellow-300 font-black' : item.completedPhases.includes('quiz') ? 'text-green-400' : 'opacity-40'}">> quiz</span>
                    <span class="text-xs uppercase ${item.phase === 'speak' ? 'text-yellow-300 font-black' : 'opacity-40'}">> speak</span>
                </div>
            ` : '<div class="text-xs uppercase opacity-40">watch > read > quiz > speak</div>';

            container.innerHTML = `
                <section class="card-bubble relative overflow-hidden p-6 md:p-10 transition-all duration-700 border-none shadow-2xl ${isHistory ? 'bg-[#0f172a]' : 'bg-[#fbbf24]'} min-h-[360px] flex items-center">
                    
                    <div id="heroContentChunk" class="flex flex-col md:flex-row items-center gap-12 w-full relative z-10 animate-in fade-in slide-in-from-right duration-500">
                        <!-- Book Display Unit -->
                        <div class="relative flex items-center justify-center w-full md:w-[320px] h-[340px] flex-shrink-0">
                            ${isHistory && items.length > 1 ? `
                                <div id="hero-left-slot" data-index="${(currentHeroIndex - 1 + items.length) % items.length}" class="absolute left-[-22%] scale-75 opacity-70 pointer-events-none transform -rotate-6 transition-all duration-500">
                                    <div class="w-48 h-64 bg-slate-900/60 backdrop-blur-md rounded-[28px] shadow-xl overflow-hidden border-2 border-white/20">
                                        ${prevItem.isPlaceholder ? `
                                            <div class="w-full h-full border-4 border-dashed border-white/30 rounded-[28px] flex flex-col items-center justify-center gap-2">
                                                <div class="w-12 h-12 rounded-full border-2 border-dashed border-white/30 flex items-center justify-center">
                                                    <span class="text-white/20 text-3xl font-black">+</span>
                                                </div>
                                            </div>
                                        ` : `<img src="${prevItem.src}" class="w-full h-full object-cover brightness-90">`}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Main Hero Card -->
                            <div id="hero-center-slot" data-index="${currentHeroIndex}" class="relative z-10 group">
                                <div class="w-56 h-[280px] rounded-[28px] shadow-2xl overflow-hidden transform border-4 ${isHistory ? 'border-white' : 'border-[#0f172a]/10'} transition-all group-hover:scale-105 cursor-pointer ${item.isPlaceholder ? 'bg-slate-900/60 backdrop-blur-xl' : 'bg-white'}" 
                                     onclick="${item.isPlaceholder ? '' : `openModal('${item.id}', '${isHistory ? 'history' : 'recommendation'}')`}">
                                    ${item.isPlaceholder ? `
                                        <div class="w-full h-full border-4 border-dashed border-white/20 rounded-[28px] flex flex-col items-center justify-center gap-4 bg-slate-900/20">
                                            <div class="w-20 h-20 rounded-full border-4 border-dashed border-white/20 flex items-center justify-center">
                                                <span class="text-white/20 text-5xl font-black">+</span>
                                            </div>
                                            <p class="text-white/20 font-black text-xl uppercase tracking-widest">Empty</p>
                                        </div>
                                    ` : `
                                        <img src="${item.src}" class="w-full h-full object-cover">
                                        <div class="absolute top-4 left-4 z-20">
                                            <div class="bg-black/40 backdrop-blur-md px-3 py-1 rounded-full border border-white/20">
                                                <p class="text-white font-black text-[9px] uppercase tracking-widest opacity-90">${isHistory ? 'In Progress' : 'Recommended'}</p>
                                            </div>
                                        </div>
                                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent flex flex-col justify-end p-5 min-h-[40%]">
                                            <h3 class="text-white font-black leading-tight text-center" style="font-size: ${item.title.length > 20 ? '14px' : '18px'}">${item.title}</h3>
                                        </div>
                                    `}
                                </div>

                                ${isHistory && items.length > 1 ? `
                                    <div class="absolute inset-y-0 -left-6 -right-6 flex items-center justify-between pointer-events-none">
                                        <button onclick="event.stopPropagation(); navigateHero(-1)" class="w-10 h-10 bg-white/30 hover:bg-white/50 backdrop-blur-md rounded-full flex items-center justify-center text-white pointer-events-auto border border-white/40 shadow-lg transition-all active:scale-90"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                                        <button onclick="event.stopPropagation(); navigateHero(1)" class="w-10 h-10 bg-white/30 hover:bg-white/50 backdrop-blur-md rounded-full flex items-center justify-center text-white pointer-events-auto border border-white/40 shadow-lg transition-all active:scale-90"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                                    </div>
                                ` : ''}
                            </div>

                            ${isHistory && items.length > 1 ? `
                                <div id="hero-right-slot" data-index="${(currentHeroIndex + 1) % items.length}" class="absolute right-[-22%] scale-75 opacity-70 pointer-events-none transform rotate-6 transition-all duration-500">
                                    <div class="w-48 h-64 bg-slate-900/60 backdrop-blur-md rounded-[28px] shadow-xl overflow-hidden border-2 border-white/20">
                                        ${nextItem.isPlaceholder ? `
                                            <div class="w-full h-full border-4 border-dashed border-white/30 rounded-[28px] flex flex-col items-center justify-center gap-2">
                                                <div class="w-12 h-12 rounded-full border-2 border-dashed border-white/30 flex items-center justify-center">
                                                    <span class="text-white/20 text-3xl font-black">+</span>
                                                </div>
                                            </div>
                                        ` : `<img src="${nextItem.src}" class="w-full h-full object-cover brightness-90">`}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Right: Text & Actions Unit -->
                        <div class="flex-1 space-y-8 text-center md:text-left transition-all duration-700 md:pl-16 ${isHistory ? 'text-white' : 'text-[#0f172a]'}">
                            <div class="space-y-4">
                                <h2 class="text-5xl md:text-7xl font-black font-fredoka drop-shadow-md leading-tight whitespace-nowrap">
                                    ${isHistory ? `Continue Your<br>Adventure, ${userName}!` : `Start Your<br>Adventure, ${userName}!`}
                                </h2>
                            </div>

                            <div class="space-y-3 max-w-2xl">
                                <div class="flex flex-col md:flex-row items-baseline justify-between font-black font-fredoka gap-6 ${isHistory ? 'text-white' : 'text-[#0f172a]'}">
                                    <div class="flex flex-wrap gap-x-8 gap-y-2 uppercase tracking-normal font-black" style="font-size: clamp(1.5rem, 4vw, 3.5rem); line-height: 1;">
                                        ${phasesText}
                                    </div>
                                    <div class="flex items-baseline gap-4 font-black ${isHistory ? 'text-sky-100' : 'text-[#0f172a]'}" style="font-size: clamp(2rem, 5vw, 3rem); line-height: 1;">
                                        ${progress}% <span class="opacity-80 uppercase" style="font-size: 0.6em;">Completed!</span>
                                    </div>
                                </div>

                                <div class="h-4 w-full rounded-full overflow-hidden border p-1 shadow-inner ${isHistory ? 'bg-black/20 border-white/10' : 'bg-[#0f172a]/10 border-[#0f172a]/10'}">
                                    <div class="h-full rounded-full transition-all duration-1000 bg-gradient-to-r ${isHistory ? 'from-sky-400 to-blue-400 shadow-[0_0_20px_rgba(56,189,248,0.4)]' : 'from-orange-500 to-orange-400 shadow-[0_0_20px_rgba(249,115,22,0.2)]'}" style="width: ${isHistory ? (progress > 0 ? Math.max(progress, 5) : 0) : 100}%"></div>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button onclick="startLearning()" class="w-full md:max-w-md py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl ${isHistory ? 'bg-[#fbbf24] text-[#0f172a] shadow-amber-900/40' : 'bg-[#0f172a] text-white hover:bg-[#1e293b] shadow-amber-900/20'} ${isHeroCTAFlashing ? 'animate-flash-yellow' : ''}">
                                    ${isHistory ? 'CONTINUE READING' : 'START READING'} <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            lucide.createIcons(); // lint: Initialize icons after rendering hero.
        }

        function navigateHero(dir) {
            currentHeroIndex = (currentHeroIndex + dir + mockHistory.length) % mockHistory.length;
            renderHero();
        }

        function renderBooks() {
            const container = document.getElementById('bookContainer');
            container.innerHTML = booksData.map(book => `
                <div key="${book.id}" onclick="openModal('${book.id}', 'recommendation')" class="w-36 md:w-40 flex-shrink-0 group cursor-pointer space-y-3 relative select-none">
                    <div class="aspect-[3/4] bg-slate-50 rounded-[32px] shadow-sm border-[4px] border-white group-hover:border-sky-300 transition-all group-hover:-translate-y-3 group-hover:shadow-2xl group-hover:shadow-sky-100 overflow-hidden relative">
                        <img src="${book.src}" class="w-full h-full object-cover pointer-events-none">
                        <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <!-- Card Bookmark Ribbon - Only show when bookmarked -->
                        ${book.isBookmarked ? `
                        <div class="absolute top-0 left-4 z-10 transition-transform group-hover:scale-110">
                            <div class="w-10 h-12 flex items-center justify-center pt-1 pb-4 rounded-b-xl border-2 border-t-0 border-white shadow-md transition-all bg-[#FF6B00] text-white">
                                <i data-lucide="bookmark" class="w-6 h-6 fill-current"></i>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <p class="text-[10px] font-black text-center text-slate-400 truncate px-4 uppercase tracking-[0.15em] group-hover:text-sky-400 transition-colors font-fredoka">${book.title}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function openModal(bookId, origin = 'recommendation') {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;
            currentModalBookId = bookId;
            currentModalOrigin = origin;

            document.getElementById('modalTitle').innerText = book.title;
            document.getElementById('modalImg').src = book.src;
            document.getElementById('modalLexile').innerText = `Lexile: ${book.lexile}`;
            document.getElementById('modalWords').innerText = `${book.wordCount} Words`;
            document.getElementById('modalCategory').innerText = book.category;
            document.getElementById('modalSummary').innerText = book.summary;
            document.getElementById('modalKeywords').innerHTML = book.keywords.map(kw => `
                <span class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">#${kw}</span>
            `).join('');

            updateBookmarkIcon(book.isBookmarked);

            // Dynamic Button Logic for Modal (Refined: Use explicit origin)
            const startBtn = document.getElementById('modalStartBtn');

            if (origin === 'history') {
                startBtn.innerHTML = `CONTINUE READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>`;
                startBtn.className = "w-full py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl bg-[#fbbf24] text-[#0f172a] shadow-amber-900/40";
                startBtn.onclick = startLearning;
            } else {
                startBtn.innerHTML = `START READING <i data-lucide="play" class="w-10 h-10 fill-current ml-2"></i>`;
                startBtn.className = "w-full py-6 rounded-[28px] font-black text-4xl flex items-center justify-center gap-4 transition-all hover:scale-[1.02] active:scale-[0.98] shadow-2xl bg-[#0f172a] text-white hover:bg-[#1e293b] shadow-amber-900/20";
                startBtn.onclick = () => {
                    const isInHistory = isHistoryMode ? mockHistory.some(h => h.id === bookId) : false;
                    const currentHeroId = freshHeroBook ? freshHeroBook.id : 'silent-stick';
                    const isCurrentHero = !isHistoryMode && bookId === currentHeroId;

                    if (!isInHistory && !isCurrentHero) {
                        addBookWithAnimation(bookId);
                    } else {
                        startLearning();
                    }
                };
            }

            const modal = document.getElementById('bookModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function closeModal() {
            const modal = document.getElementById('bookModal');
            const content = document.getElementById('modalContent');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            document.body.style.overflow = 'auto';
        }

        function playWhoosh() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                if (context.state === 'suspended') {
                    context.resume();
                }
                const oscillator = context.createOscillator();
                const gain = context.createGain();
                const filter = context.createBiquadFilter();

                oscillator.type = 'triangle';
                filter.type = 'highpass';
                filter.Q.value = 10;

                oscillator.connect(filter);
                filter.connect(gain);
                gain.connect(context.destination);

                const now = context.currentTime;
                const duration = 1.0;

                // Frequency sweep: Swish up then down
                oscillator.frequency.setValueAtTime(400, now);
                oscillator.frequency.exponentialRampToValueAtTime(1800, now + duration * 0.4);
                oscillator.frequency.exponentialRampToValueAtTime(600, now + duration);

                // Filter resonance sweep
                filter.frequency.setValueAtTime(1000, now);
                filter.frequency.exponentialRampToValueAtTime(4000, now + duration * 0.5);
                filter.frequency.exponentialRampToValueAtTime(1500, now + duration);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                oscillator.start(now);
                oscillator.stop(now + duration);
            } catch (e) {
                console.error("Audio failed:", e);
            }
        }


        function renderReadPhase() {
            const phaseContainer = document.getElementById('phase-read');
            const book = booksData.find(b => b.id === currentModalBookId);
            const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);
            setPhase('read');
            currentPhase = 'read';
            if (currentReadStep === 'selection') {
                phaseContainer.innerHTML = `
                    <div class="relative z-10 flex-1 flex flex-col items-center justify-center animate-in fade-in duration-500 min-h-screen">
                        <!-- Backdrop -->
                        <div class="absolute inset-0">
                            <img src="./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png" class="w-full h-full object-cover opacity-60 brightness-75" />
                            <div class="absolute inset-0 bg-black/40"></div>
                        </div>

                        <!-- Selection Modal -->
                        <div class="relative z-20 w-full max-w-4xl bg-white rounded-[48px] shadow-2xl p-12 flex flex-col items-center gap-12">
                            <div class="flex gap-8 w-full">
                                <button onclick="selectReadingMode('ebook')" id="card-ebook" class="flex-1 group transition-all duration-300">
                                    <div class="aspect-[4/3] bg-slate-50 rounded-[32px] p-8 border-4 transition-all flex flex-col items-center justify-center gap-6 group-hover:bg-sky-50 outline-none
                                        ${selectedReadingMode === 'ebook' ? 'border-sky-400 bg-sky-50 shadow-[0_0_30px_rgba(56,189,248,0.3)]' : 'border-slate-100 group-hover:border-sky-200'}">
                                        <div class="w-full h-48 bg-white rounded-2xl shadow-lg flex items-center justify-center group-hover:scale-110 transition-transform overflow-hidden relative border-4 border-white px-4">
                                            <img src="./public/UI/Ebook.png" alt="ebook" class="w-full h-full object-contain" onerror="this.src='https://img.icons8.com/color/144/storybook.png'"/>
                                        </div>
                                        <h3 class="text-3xl font-black text-slate-800 font-fredoka">E-book</h3>
                                    </div>
                                </button>
                                <button onclick="selectReadingMode('interactive')" id="card-interactive" class="flex-1 group transition-all duration-300">
                                    <div class="aspect-[4/3] bg-slate-50 rounded-[32px] p-8 border-4 transition-all flex flex-col items-center justify-center gap-6 group-hover:bg-sky-50 outline-none
                                        ${selectedReadingMode === 'interactive' ? 'border-sky-400 bg-sky-50 shadow-[0_0_30px_rgba(56,189,248,0.3)]' : 'border-slate-100 group-hover:border-sky-200'}">
                                        <div class="w-full h-48 bg-white rounded-2xl shadow-lg flex items-center justify-center group-hover:rotate-12 transition-transform overflow-hidden relative border-4 border-white px-4">
                                            <img src="./public/UI/Anibook.png" alt="anibook" class="w-full h-full object-contain" onerror="this.src='https://img.icons8.com/color/144/dragon.png'"/>
                                        </div>
                                        <h3 class="text-3xl font-black text-slate-800 font-fredoka">Ani-book</h3>
                                    </div>
                                </button>
                            </div>
                            <button id="modeOkBtn" onclick="goToReadStep('intro')" ${!selectedReadingMode ? 'disabled' : ''} class="w-full h-20 bg-slate-900 text-white rounded-[24px] text-2xl font-black shadow-xl hover:bg-slate-800 active:scale-95 transition-all disabled:opacity-30 disabled:pointer-events-none">OK</button>
                            <p class="text-slate-400 font-bold">* You <span class="underline decoration-slate-300">can't change the mode</span> while reading.</p>
                        </div>
                    </div>
                `;
            } else if (currentReadStep === 'intro') {
                phaseContainer.innerHTML = `
                    <div class="relative z-10 flex-1 flex flex-col animate-in fade-in duration-500 min-h-screen">
                        <div class="absolute inset-0">
                            <img src="./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png" class="w-full h-full object-cover" />
                        </div>
                        <div class="absolute top-20 left-1/2 -translate-x-1/2 px-16 py-6 bg-white/70 backdrop-blur-md rounded-[32px] shadow-2xl border-4 border-white/20">
                            <h1 class="text-7xl font-black text-slate-900 font-fredoka tracking-tight">${book.title}</h1>
                        </div>
                        <div class="absolute bottom-12 left-12 w-[580px] bg-white/70 backdrop-blur-md rounded-[48px] shadow-2xl p-12 flex flex-col gap-6 border-4 border-white/30 text-left">
                            <div class="flex gap-4">
                                <span class="px-5 py-2 bg-white rounded-2xl text-slate-900 font-black text-xl border-2 border-slate-200 tracking-tight text-center uppercase">${selectedReadingMode}</span>
                                <span class="px-5 py-2 bg-white rounded-2xl text-slate-900 font-black text-xl border-2 border-slate-200 tracking-tight text-center uppercase">LEXILE ${book.lexile}</span>
                            </div>
                            <p class="text-slate-900 text-[2.2rem] font-black leading-tight text-left">
                                "${filteredScenes[0]?.script?.substring(0, 100)}..."
                            </p>
                            <div class="flex flex-col gap-3 mt-2">
                                <span class="px-4 py-1.5 bg-sky-100 text-sky-600 rounded-xl font-black text-sm uppercase self-start">Keywords</span>
                                <p class="text-slate-600 font-black text-xl leading-relaxed text-left">${book.keywords.join(', ')}</p>
                            </div>
                        </div>
                        <button onclick="goToReadStep('viewing')" class="absolute bottom-12 right-12 px-24 h-28 bg-white rounded-[40px] flex items-center justify-center text-slate-900 text-5xl font-black font-fredoka shadow-2xl hover:scale-110 active:scale-95 transition-all border-8 border-white animate-twinkle">START</button>
                    </div>
                `;
            } else {
                if (currentSceneIndex > maxReachedSceneIndex) {
                    maxReachedSceneIndex = currentSceneIndex;
                }

                const scene = filteredScenes[currentSceneIndex];

                if (!scene.fetchedScript && !scene.isFetching) {
                    scene.isFetching = true;
                    fetchSceneScript(scene).then(text => {
                        scene.fetchedScript = text;
                        scene.isFetching = false;
                        if (currentSceneIndex === filteredScenes.indexOf(scene)) {
                            renderReadPhase();
                        }
                    });
                }

                const script = scene.fetchedScript || scene.script;
                const sentences = script.split(/(?<=[.!?]) +/);
                const sentencesHtml = sentences.map((sentence, idx) => `
                    <span onclick="event.stopPropagation(); playSentenceAudio(${idx})" class="cursor-pointer hover:text-orange-300 transition-colors pointer-events-auto inline-block mr-3 mb-2 ${playingSentenceIndex === idx ? 'text-orange-400 drop-shadow-[0_0_15px_rgba(251,146,60,0.8)] scale-105' : ''}">
                        ${sentence}
                    </span>
                `).join('');

                const dotsHtml = filteredScenes.map((_, index) => `
                    <div class="w-3 h-3 rounded-full transition-all duration-300 ${index === currentSceneIndex ? 'bg-[#FF6B00] scale-125 shadow-[0_0_10px_#FF6B00]' : 'bg-white/40'}"></div>
                `).join('');

                const positionClass = getTextPositionClass(currentSceneIndex);

                phaseContainer.innerHTML = `
                    <div class="absolute inset-0 bg-black z-0 flex flex-col overflow-hidden animate-in fade-in duration-500">
                        <img src="${scene.image_url}" class="absolute inset-0 w-full h-full object-cover" />
                        
                        <!-- Shared Text Overlay -->
                        <div class="absolute z-50 p-12 max-w-[1400px] transition-all duration-500 ease-in-out flex items-start gap-8 pointer-events-none ${positionClass.replace('items-start', '').replace('items-end', '')} ${positionClass.includes('left-') ? 'ml-32' : ''} ${positionClass.includes('right-') ? 'mr-32' : ''}">
                            <!-- Play Button -->
                            <button onclick="event.stopPropagation(); playFullSceneAudio()" class="mt-40 w-14 h-14 bg-[#FF6B00] rounded-full shadow-[0_4px_15px_rgba(255,107,0,0.5)] flex items-center justify-center text-white hover:bg-[#FF8500] hover:scale-110 active:scale-95 transition-all pointer-events-auto flex-shrink-0 ${isSceneAudioPlaying ? 'ring-4 ring-orange-300' : ''}">
                                <i data-lucide="play" class="w-8 h-8 ${isSceneAudioPlaying ? 'fill-current' : ''}"></i>
                            </button>

                            <div class="flex-1 pointer-events-auto">
                                <p class="text-white text-4xl md:text-5xl lg:text-6xl font-black font-fredoka leading-[1.3] drop-shadow-[0_8px_16px_rgba(0,0,0,0.9)] whitespace-pre-line ${positionClass.includes('text-right') ? 'text-right' : 'text-left'}">
                                    ${sentencesHtml}
                                </p>
                            </div>
                        </div>

                        ${isScenePickerOpen ? `<div class="absolute inset-0 z-[60] pointer-events-auto" onclick="isScenePickerOpen = false; renderReadPhase();"></div>` : ''}

                        <button onclick="isScenePickerOpen = true; renderReadPhase();" class="absolute bottom-12 left-1/2 -translate-x-1/2 flex items-center gap-4 px-6 py-3 bg-black/40 backdrop-blur-xl rounded-full border border-white/20 z-30 hover:scale-105 active:scale-95 transition-all group ${isScenePickerOpen ? 'translate-y-20 opacity-0 pointer-events-none' : 'translate-y-0 opacity-100'}">
                            <div class="text-white group-hover:text-[#FF6B00] transition-colors"><i data-lucide="chevron-up" class="w-6 h-6"></i></div>
                            <div class="flex items-center gap-2">${dotsHtml}</div>
                        </button>

                        <div id="scenePicker" class="absolute bottom-0 inset-x-0 bg-black/80 backdrop-blur-2xl border-t border-white/10 transition-all duration-500 ease-out z-[70] pb-12 pt-8 ${isScenePickerOpen ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0 pointer-events-none'}" onclick="event.stopPropagation()">
                            <div class="px-12">
                                <button onclick="isScenePickerOpen = false; renderReadPhase();" class="w-full flex justify-center mb-6 py-2 group">
                                    <div class="bg-black/80 backdrop-blur-md rounded-full px-8 py-2 border border-white/20 flex items-center gap-4 shadow-lg group-hover:scale-105 transition-all">
                                        <div class="text-white group-hover:text-[#FF6B00] transition-colors"><i data-lucide="chevron-down" class="w-5 h-5"></i></div>
                                        <div class="flex items-center gap-2">
                                            ${filteredScenes.map((_, index) => `<div class="w-2 h-2 rounded-full transition-all duration-300 ${index === currentSceneIndex ? 'bg-[#FF6B00]' : 'bg-white/30'}"></div>`).join('')}
                                        </div>
                                    </div>
                                </button>
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-white/60 font-black text-xl font-fredoka uppercase tracking-widest flex items-center gap-3"><i data-lucide="sparkles" class="w-5 h-5 text-[#FF6B00]"></i>Jump to Scene</h3>
                                    <span class="text-white/30 font-bold font-jua text-lg bg-white/5 px-4 py-1 rounded-full border border-white/5">${currentSceneIndex + 1} / ${filteredScenes.length}</span>
                                </div>
                                <div class="flex gap-4 overflow-x-auto pb-12 pt-4 scrollbar-hide snap-x no-scrollbar">
                                    ${filteredScenes.map((s, index) => {
                    const isUnlocked = index <= maxReachedSceneIndex;
                    const isActive = index === currentSceneIndex;
                    return `<button ${!isUnlocked ? 'disabled' : `onclick="jumpToScene(${index})"`} class="relative flex-shrink-0 w-48 aspect-video rounded-2xl overflow-hidden snap-start transition-all duration-300 ${isActive ? 'ring-4 ring-[#FF6B00] scale-105 shadow-[0_0_30px_rgba(255,107,0,0.3)] z-10' : 'ring-2 ring-white/5 hover:ring-white/20'} ${!isUnlocked ? 'opacity-40 grayscale pointer-events-none' : ''}">
                                            <img src="${s.image_url}" class="w-full h-full object-cover" onerror="this.src='https://img.icons8.com/color/144/image.png'" />
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                                            <div class="absolute bottom-3 left-4 text-white font-black text-sm font-fredoka flex items-center gap-2"><span class="opacity-60 text-[10px] uppercase">SC</span><span>${String(index + 1).padStart(2, '0')}</span></div>
                                            ${!isUnlocked ? `<div class="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-[1px]"><div class="w-10 h-10 bg-black/40 rounded-full flex items-center justify-center border border-white/10 shadow-xl"><i data-lucide="lock" class="w-5 h-5 text-white/90"></i></div></div>` : ''}
                                            ${isActive ? `<div class="absolute top-3 right-3 w-4 h-4 bg-[#FF6B00] rounded-full shadow-[0_0_10px_#FF6B00] flex items-center justify-center"><div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div></div>` : ''}
                                        </button>`;
                }).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="absolute inset-y-0 inset-x-8 flex items-center justify-between pointer-events-none">
                            <button onclick="prevScene()" class="w-24 h-24 rounded-full bg-white/10 hover:bg-white/20 border-4 border-white/20 flex items-center justify-center text-white pointer-events-auto transition-all active:scale-90 ${currentSceneIndex === 0 ? 'opacity-0 pointer-events-none' : ''}">
                                <i data-lucide="chevron-left" class="w-12 h-12"></i>
                            </button>
                            <button onclick="nextScene()" class="w-24 h-24 rounded-full bg-white hover:scale-110 flex items-center justify-center text-slate-900 shadow-2xl pointer-events-auto transition-all active:scale-90">
                                <i data-lucide="chevron-right" class="w-12 h-12"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        window.prevScene = function () {
            if (currentSceneIndex > 0) {
                stopAudio();
                currentSceneIndex--;
                renderReadPhase();
            }
        };

        window.nextScene = function () {
            const filteredScenes = mockScenes.filter(s => s.id === currentModalBookId);

            if (currentSceneIndex < filteredScenes.length - 1) {
                stopAudio();
                currentSceneIndex++;
                if (currentSceneIndex > maxReachedSceneIndex) {
                    maxReachedSceneIndex = currentSceneIndex;
                }
                renderReadPhase();
            } else {
                stopAudio();
                showReadCompletePraise();
            }
        };

        window.exitReadPhase = function () { // lint: New function to exit the read phase and return to home.
            stopAudio();
            currentPhase = 'home';
            location.reload(); // Simple way to restore home state in prototype
        };

        function toggleBookmarkModal() {
            const book = booksData.find(b => b.id === currentModalBookId);
            if (book) {
                book.isBookmarked = !book.isBookmarked;
                updateBookmarkIcon(book.isBookmarked);
                renderBooks();
            }
        }

        function updateBookmarkIcon(isBookmarked) {
            const btn = document.getElementById('modalBookmarkBtn');
            const icon = document.getElementById('modalBookmarkIcon');
            if (isBookmarked) {
                btn.classList.remove('bg-white', 'text-slate-200');
                btn.classList.add('bg-[#FF6B00]', 'text-white');
                icon.classList.add('fill-current');
            } else {
                btn.classList.remove('bg-[#FF6B00]', 'text-white');
                btn.classList.add('bg-white', 'text-slate-200');
                icon.classList.remove('fill-current');
            }
            lucide.createIcons();
        }

        function addBookWithAnimation(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            closeModal();
            playWhoosh();

            // 1. Create Sucking Overlay & Calculate Target
            // Detect which visual slot is currently the placeholder (dashed border)
            const leftPlaceholder = document.querySelector('#hero-left-slot .border-dashed');
            const centerPlaceholder = document.querySelector('#hero-center-slot .border-dashed');
            const rightPlaceholder = document.querySelector('#hero-right-slot .border-dashed');

            let targetSlotElement = null;
            if (leftPlaceholder) targetSlotElement = document.getElementById('hero-left-slot');
            else if (centerPlaceholder) targetSlotElement = document.getElementById('hero-center-slot');
            else if (rightPlaceholder) targetSlotElement = document.getElementById('hero-right-slot');
            else targetSlotElement = document.getElementById('hero-center-slot'); // Replacement logic

            if (targetSlotElement) {
                targetLogicalIndex = parseInt(targetSlotElement.getAttribute('data-index') || '2', 10);
            }

            const targetRect = targetSlotElement ? targetSlotElement.getBoundingClientRect() : { left: window.innerWidth * 0.75, top: window.innerHeight * 0.25, width: 0, height: 0 };
            const targetX = targetRect.left + (targetRect.width / 2);
            const targetY = targetRect.top + (targetRect.height / 2);

            const overlay = document.createElement('div');
            overlay.className = 'animate-suck-to-hero rounded-[32px] overflow-hidden shadow-2xl border-4 border-white';
            overlay.style.width = '240px';
            overlay.style.height = '320px';
            overlay.style.setProperty('--target-x', `${targetX}px`);
            overlay.style.setProperty('--target-y', `${targetY}px`);
            overlay.innerHTML = `<img src="${book.src}" class="w-full h-full object-cover">`;
            document.body.appendChild(overlay);

            // 2. Wait for animation
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }

                if (!isHistoryMode) {
                    // Fresh Mode: Replace the Hero cover
                    freshHeroBook = { ...book };
                    isHeroCTAFlashing = true;
                    renderHero();
                    setTimeout(() => {
                        isHeroCTAFlashing = false;
                        renderHero();
                    }, 5000);
                } else {
                    // History Mode: Fill the placeholder
                    while (mockHistory.length <= targetLogicalIndex) {
                        mockHistory.push({ id: '', src: '', title: '', phase: '', completedPhases: [], isPlaceholder: true });
                    }
                    mockHistory[targetLogicalIndex] = { ...book, progress: 0, phase: 'watch', completedPhases: [] };
                    renderHero();

                    // stage 2: Trigger smooth reordering after 200ms pause
                    setTimeout(() => {
                        // Final desired order: Left(Silent-Stick), Center(Rainbow-Cloud), Right(Milo)
                        mockHistory = [
                            { id: 'silent-stick', title: 'The Silent Stick', src: './public/Image/Cover/The Silent Stick.png', progress: 0, phase: 'watch', completedPhases: [] },
                            { ...book, progress: 0, phase: 'watch', completedPhases: [] },
                            { id: 'milo', title: 'Milo and the Lost Color', src: './public/Image/Cover/Milo and the Lost Color.png', progress: 50, phase: 'quiz', completedPhases: ['watch', 'read'] }
                        ];
                        currentHeroIndex = 1; // Center the new book
                        isHeroCTAFlashing = true;
                        renderHero();

                        setTimeout(() => {
                            isHeroCTAFlashing = false;
                            renderHero();
                        }, 5000);
                    }, 200);
                }
            }, 1000);
        }

        let isGnbVisible = true;
        let gnbTimeout = null;
        let isReadUnlocked = false;

        // Scene Picker Progress
        let maxReachedSceneIndex = 0;
        let isScenePickerOpen = false;

        function startLearning() {
            closeModal();
            const book = booksData.find(b => b.id === currentModalBookId) || booksData[0];

            // Show the overlay first
            const overlay = document.getElementById('learningModeOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('active');
            }, 10);
            document.body.style.overflow = 'hidden';

            // IMPORTANT: check history to decide phase. 
            // If progress is low or not in history, always start with Watch phase video.
            const history = mockHistory.find(h => h.id === book.id);
            const shouldStartRead = history && (history.phase === 'read' || history.completedPhases.includes('watch'));

            if (shouldStartRead) {
                const relevantScenes = scenesData.filter(s => s.book_id === book.id);
                if (relevantScenes.length > 0) {
                    currentPhase = 'read';
                    currentSceneIndex = 0;
                    renderReadPhase();
                    return;
                }
            }

            // Fallback to Watch phase (Default)
            document.getElementById('studyBookTitle').innerText = book.title;
            const video = document.getElementById('studyVideo');
            // Ensure path is correct and call load() to reset the player
            video.src = book.videoUrl || "./public/Video/The_silent_stick_watch.mp4";
            video.load();

            setPhase('watch');
            showGnb();
            startGnbTimer();

            // Video listeners
            video.addEventListener('timeupdate', updateProgressBar);
            video.addEventListener('error', (e) => {
                console.error("Video Error:", video.error);
                alert("Video Failed to Load: " + video.src + "\nError Code: " + (video.error ? video.error.code : 'unknown'));
            });
            video.addEventListener('play', () => {
                document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
                lucide.createIcons();
            });
            video.addEventListener('pause', () => {
                document.getElementById('playIcon').setAttribute('data-lucide', 'play');
                lucide.createIcons();
            });
        }

        function exitLearningMode() {
            const video = document.getElementById('studyVideo');
            video.pause();
            document.getElementById('learningModeOverlay').classList.remove('active');
            setTimeout(() => {
                document.getElementById('learningModeOverlay').classList.add('hidden');
                document.body.style.overflow = 'auto';
                resetLearningMode();
            }, 600);
        }

        function resetLearningMode() {
            isReadUnlocked = false;
            currentPhase = 'watch';
            document.getElementById('tab-read').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('tab-read').innerHTML = '<i data-lucide="book-open" class="w-4 h-4"></i> Read <i data-lucide="lock" class="w-3 h-3"></i>';
            document.getElementById('nextPhaseContainer').classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            setPhase('watch');
            lucide.createIcons();
        }

        function showGnb() {
            document.getElementById('studyGnb').style.transform = 'translateY(0)';
            document.getElementById('gnbHandleIcon').setAttribute('data-lucide', 'chevron-up');
            // Show GNB background overlay if it was closed
            isGnbVisible = true;
            lucide.createIcons();
        }

        function hideGnb() {
            document.getElementById('studyGnb').style.transform = 'translateY(-100%)';
            document.getElementById('gnbHandleIcon').setAttribute('data-lucide', 'chevron-down');
            isGnbVisible = false;
            lucide.createIcons();
        }

        function toggleGnb(forceToggle = false) {
            if (isGnbVisible) hideGnb();
            else showGnb();
        }

        function startGnbTimer() {
            clearTimeout(gnbTimeout);
            gnbTimeout = setTimeout(() => {
                const video = document.getElementById('studyVideo');
                if (!video.paused) {
                    hideGnb();
                }
            }, 3000);
        }

        function handleMainClick() {
            // No automatic toggle on background click as requested
        }

        function setPhase(phase) {
            if (phase === 'read' && !isReadUnlocked) return;

            currentPhase = phase;
            document.getElementById('phase-watch').classList.add('hidden');
            document.getElementById('phase-read').classList.add('hidden');
            document.getElementById(`phase-${phase}`).classList.remove('hidden');

            // Update Tabs
            const tabs = ['watch', 'read'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (btn) {
                    // Check if this tab is unlocked
                    const isUnlocked = (t === 'watch') || (t === 'read' && isReadUnlocked);

                    // Reset all tabs to default state
                    btn.classList.remove('bg-white', 'text-orange-500', 'shadow-sm', 'opacity-50', 'cursor-not-allowed', 'text-slate-400', 'text-slate-700');

                    if (isUnlocked) {
                        // Unlocked Style (Inactive but clickable)
                        btn.classList.add('text-slate-700');
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.removeAttribute('disabled');

                        // Remove lock icon if present
                        const lockIcon = btn.querySelector('[data-lucide="lock"]');
                        if (lockIcon) lockIcon.remove();
                    } else {
                        // Locked Style
                        btn.classList.add('text-slate-400', 'opacity-50', 'cursor-not-allowed');
                        btn.setAttribute('disabled', 'true');
                    }

                    if (t === phase && isUnlocked) {
                        // Highlight active phase in Orange
                        btn.classList.add('bg-white', 'text-orange-500', 'shadow-sm');
                        btn.classList.remove('text-slate-700');
                    }
                }
            });

            if (phase === 'read') {
                document.getElementById('studyVideo').pause();
            }
        }

        // Video Logic
        function togglePlay() {
            const video = document.getElementById('studyVideo');
            const centralIcon = document.getElementById('centralPlayIcon');
            const playIcon = document.getElementById('playIcon');
            const overlay = document.getElementById('videoCentralOverlay');

            if (video.paused) {
                video.play();
                centralIcon.setAttribute('data-lucide', 'pause');
                playIcon.setAttribute('data-lucide', 'pause');
                overlay.classList.add('opacity-0', 'group-hover:opacity-100');
                hideGnb();
            } else {
                video.pause();
                centralIcon.setAttribute('data-lucide', 'play');
                playIcon.setAttribute('data-lucide', 'play');
                overlay.classList.remove('opacity-0', 'group-hover:opacity-100');
                showGnb();
            }
            lucide.createIcons();
        }

        function skipVideo(seconds) {
            const video = document.getElementById('studyVideo');
            video.currentTime += seconds;
        }

        function seekVideo(e) {
            const video = document.getElementById('studyVideo');
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
        }

        function updateProgressBar() {
            const video = document.getElementById('studyVideo');
            const progress = (video.currentTime / video.duration) * 100;
            document.getElementById('videoProgress').style.width = `${progress}%`;
        }

        function cyclePlaybackRate() {
            const video = document.getElementById('studyVideo');
            const rates = [1, 1.5, 2, 0.5];
            let currentIdx = rates.indexOf(video.playbackRate);
            let nextIdx = (currentIdx + 1) % rates.length;
            video.playbackRate = rates[nextIdx];
            document.getElementById('playbackRateText').innerText = `${rates[nextIdx]}x`;
        }

        const mockBookMeta = {
            title: "The Silent Stick",
            level: 4,
            lexile: "300~350",
            word_count: 140,
            summary: "The frozen lake lay still under the winter moon. A lone boy discovered a mysterious staff that hummed with a quiet power... Join him as he uncovers the secrets of the enchanted forest.",
            keywords: ["frozen lake", "mysterious staff", "enchanted forest", "adventure"],
            cover_url: "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=2070"
        };

        const mockScenes = [
            { id: 'silent-stick', scene_no: "SC01", script: "The frozen lake lay still, \na big area of gray ice \nbeneath a heavy winter sky.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC01.mp3" },
            { id: 'silent-stick', scene_no: "SC02", script: "He hit the puck with force, \nbut his old stick broke \nsuddenly upon impact.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC02.mp3" },
            { id: 'silent-stick', scene_no: "SC03", script: "Two pieces of wood lay on the ice, \nshowing the end of his practice.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC03.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC03.mp3" },
            { id: 'silent-stick', scene_no: "SC04", script: "Ren worked for hours, \ncutting the skin to show \nthe hard wood under.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC04.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC04.mp3" },
            { id: 'silent-stick', scene_no: "SC05", script: "When he tested it, \nthe puck flew in strange circles \ndue to the woodâ€™s natural shape.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC05.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC05.mp3" },
            { id: 'silent-stick', scene_no: "SC06", script: "Jax glanced at Renâ€™s rough branch \nand offered a cold smile, saying nothing.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC06.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC06.mp3" },
            { id: 'silent-stick', scene_no: "SC07", script: "Jax controlled the ice, \nhis speed pushing Ren \nback toward his own goal.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC07.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC07.mp3" },
            { id: 'silent-stick', scene_no: "SC08", script: "The puck turned around the confused player, \ngoing quietly into the net as the whistle blew.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC08.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC08.mp3" },
            { id: 'silent-stick', scene_no: "SC09", script: "Ren smiled at his rough stick \nand skated away silently.", image_url: "./public/Image/Book/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC09.png", full_audio: "./public/Audio/OG_0001(The Silent Stick)_lv4/OG_0001(The Silent Stick)_lv4_SC09.mp3" }
        ];

        // [NEW] Helper for text positioning
        function getTextPositionClass(index) {
            switch (index) {
                case 0: // SC01
                    return "top-8 left-8 md:top-16 md:left-16 text-left items-start";
                case 1: // SC02
                case 2: // SC03
                case 4: // SC05
                    return "top-8 right-8 md:top-16 md:right-16 text-left items-start";
                case 3: // SC04
                    return "bottom-24 right-8 md:bottom-32 md:right-16 text-left items-start";
                case 5: // SC06
                case 6: // SC07
                case 7: // SC08
                    return "bottom-24 left-8 md:bottom-32 md:left-16 text-left items-start";
                case 8: // SC09
                    return "top-1/2 -translate-y-1/2 left-24 md:left-32 text-left items-start";
                default:
                    return "top-8 left-8 md:top-16 md:left-16 text-left items-start";
            }
        }

        // [NEW] Async Text Fetcher
        let currentAudio = null;
        let playingSentenceIndex = null;
        let isSceneAudioPlaying = false;

        function playFullSceneAudio() {
            const scenes = mockScenes.filter(s => s.id === currentModalBookId);
            const scene = scenes[currentSceneIndex];
            if (!scene || !scene.full_audio) return;

            if (currentAudio) currentAudio.pause();

            currentAudio = new Audio(scene.full_audio);
            isSceneAudioPlaying = true;
            playingSentenceIndex = null;

            currentAudio.play().catch(err => console.error("Audio play failed:", err));
            currentAudio.onended = () => {
                isSceneAudioPlaying = false;
                renderReadPhase();
            };
            renderReadPhase();
        }

        function playSentenceAudio(index) {
            const scenes = mockScenes.filter(s => s.id === currentModalBookId);
            const scene = scenes[currentSceneIndex];
            if (!scene || !scene.full_audio) return;

            if (currentAudio) currentAudio.pause();

            currentAudio = new Audio(scene.full_audio);
            playingSentenceIndex = index;
            isSceneAudioPlaying = false;

            currentAudio.play().catch(err => console.error("Sentence audio play failed:", err));
            currentAudio.onended = () => {
                playingSentenceIndex = null;
                renderReadPhase();
            };
            renderReadPhase();
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            playingSentenceIndex = null;
            isSceneAudioPlaying = false;
        }

        async function fetchSceneScript(scene) {
            if (scene.fetchedScript) return scene.fetchedScript;

            // Derive path: ./public/Image/.../SC01.png -> ./public/Data/.../SC01.txt
            // Note: prototype.html is at root, so ./public is correct.
            const textUrl = scene.image_url.replace('/Image/', '/Data/').replace('.png', '.txt').replace('.jpg', '.txt');
            try {
                const res = await fetch(textUrl);
                if (res.ok) {
                    const text = await res.text();
                    if (text && !text.includes('<!DOCTYPE html>')) {
                        scene.fetchedScript = text;
                        return text;
                    }
                }
            } catch (e) {
                console.error("Fetch failed", e);
            }
            return scene.script; // Fallback
        }

        let currentReadStep = 'selection';

        function goToReadStep(step) {
            currentReadStep = step;
            renderReadPhase();
        }

        function selectReadingMode(mode) {
            selectedReadingMode = mode;
            renderReadPhase();
        }

        // [NEW] Read Complete Praise Overlay
        function showReadCompletePraise() {
            const overlay = document.createElement('div');
            overlay.id = 'readCompletePraise';
            overlay.className = 'fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center animate-in fade-in duration-500 cursor-pointer';
            overlay.onclick = () => {
                overlay.remove();
                showSpeakSelectionModal();
            };
            overlay.innerHTML = `
                <div class="relative flex flex-col items-center justify-center animate-in zoom-in-50 duration-500">
                    <!-- Glow Effect -->
                    <div class="absolute inset-0 bg-yellow-400/30 blur-[100px] rounded-full"></div>
                    
                    <!-- Praise Badge Image -->
                    <img src="./public/UI/praise_badge.png" alt="Great! Let's speak" class="w-[600px] h-auto object-contain drop-shadow-2xl relative z-10 hover:scale-105 transition-transform duration-300" />
                    
                    <p class="mt-8 text-white text-2xl font-fredoka font-bold animate-pulse">Click to continue</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // [NEW] Scene Selection Modal
        function showSpeakSelectionModal() {
            const overlay = document.createElement('div');
            overlay.id = 'speakSelectionModal';
            overlay.className = 'fixed inset-0 z-[120] bg-black/60 backdrop-blur-md flex items-center justify-center animate-in fade-in duration-300';

            // Generate Scene Checkboxes
            const sceneGridHtml = mockScenes.map((scene, idx) => `
                <div class="relative group cursor-pointer" onclick="toggleSceneSelection(${idx})">
                    <div class="aspect-video bg-slate-100 rounded-xl overflow-hidden border-4 transition-all duration-200 ${idx === 0 ? 'border-orange-500 ring-4 ring-orange-200' : 'border-slate-200 group-hover:border-orange-300'}" id="scene-card-${idx}">
                        <img src="${scene.image_url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                        
                        <!-- Checkbox Overlay -->
                        <div class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg border-2 ${idx === 0 ? 'border-orange-500 bg-orange-500 text-white' : 'border-slate-300 text-transparent'}" id="scene-check-${idx}">
                            <i data-lucide="check" class="w-5 h-5 font-bold"></i>
                        </div>
                        
                        <!-- Scene Label -->
                        <div class="absolute bottom-0 inset-x-0 bg-black/50 text-white text-center py-1 text-sm font-bold backdrop-blur-sm">
                            Scene ${idx + 1}
                        </div>
                    </div>
                </div>
            `).join('');

            overlay.innerHTML = `
                <div class="bg-white rounded-[40px] p-8 w-[90%] max-w-5xl shadow-2xl animate-in slide-in-from-bottom-10 duration-500 relative">
                    <!-- Close Button -->
                    <button onclick="document.getElementById('speakSelectionModal').remove()" class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 transition-colors">
                        <i data-lucide="x" class="w-8 h-8 text-slate-400"></i>
                    </button>

                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-black text-slate-800 font-fredoka mb-2">Scenes you want to Read Aloud</h2>
                        <div class="flex items-center justify-center gap-2">
                             <label class="flex items-center gap-2 cursor-pointer select-none">
                                <div class="w-6 h-6 border-2 border-slate-300 rounded-md flex items-center justify-center transition-colors text-white" id="selectAllCheck" onclick="toggleSelectAll()">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </div>
                                <span class="text-slate-500 font-bold text-lg">All</span>
                            </label>
                        </div>
                    </div>

                    <!-- Scene Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto p-2">
                        ${sceneGridHtml}
                    </div>

                    <!-- Footer Action -->
                    <div class="mt-8 flex justify-center">
                        <button onclick="confirmSpeakSelection()" class="px-16 py-4 bg-white border-4 border-slate-200 text-slate-700 rounded-full text-2xl font-black font-fredoka hover:bg-orange-500 hover:text-white hover:border-orange-500 transition-all shadow-xl hover:shadow-orange-200 active:scale-95">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            lucide.createIcons();
        }

        // [NEW] Selection Logic
        let selectedScenes = [0]; // Default first scene selected

        function toggleSceneSelection(idx) {
            const index = selectedScenes.indexOf(idx);
            const card = document.getElementById(`scene-card-${idx}`);
            const check = document.getElementById(`scene-check-${idx}`);

            if (index > -1) {
                selectedScenes.splice(index, 1);
                // Visual Uncheck
                card.classList.remove('border-orange-500', 'ring-4', 'ring-orange-200');
                card.classList.add('border-slate-200');
                check.classList.remove('border-orange-500', 'bg-orange-500', 'text-white');
                check.classList.add('border-slate-300', 'text-transparent');
            } else {
                selectedScenes.push(idx);
                // Visual Check
                card.classList.add('border-orange-500', 'ring-4', 'ring-orange-200');
                card.classList.remove('border-slate-200');
                check.classList.add('border-orange-500', 'bg-orange-500', 'text-white');
                check.classList.remove('border-slate-300', 'text-transparent');
            }
            updateSelectAllState();
        }

        function toggleSelectAll() {
            const isAll = selectedScenes.length === mockScenes.length;
            const selectAllCheck = document.getElementById('selectAllCheck');

            if (isAll) {
                selectedScenes = [];
                // Uncheck all UI
                mockScenes.forEach((_, i) => {
                    const card = document.getElementById(`scene-card-${i}`);
                    const check = document.getElementById(`scene-check-${i}`);
                    card.classList.remove('border-orange-500', 'ring-4', 'ring-orange-200');
                    card.classList.add('border-slate-200');
                    check.classList.remove('border-orange-500', 'bg-orange-500', 'text-white');
                    check.classList.add('border-slate-300', 'text-transparent');
                });
                selectAllCheck.classList.remove('bg-orange-500', 'border-orange-500');
                selectAllCheck.classList.add('border-slate-300');
            } else {
                selectedScenes = mockScenes.map((_, i) => i);
                // Check all UI
                mockScenes.forEach((_, i) => {
                    const card = document.getElementById(`scene-card-${i}`);
                    const check = document.getElementById(`scene-check-${i}`);
                    card.classList.add('border-orange-500', 'ring-4', 'ring-orange-200');
                    card.classList.remove('border-slate-200');
                    check.classList.add('border-orange-500', 'bg-orange-500', 'text-white');
                    check.classList.remove('border-slate-300', 'text-transparent');
                });
                selectAllCheck.classList.add('bg-orange-500', 'border-orange-500');
                selectAllCheck.classList.remove('border-slate-300');
            }
        }

        function updateSelectAllState() {
            const isAll = selectedScenes.length === mockScenes.length;
            const selectAllCheck = document.getElementById('selectAllCheck');
            if (isAll) {
                selectAllCheck.classList.add('bg-orange-500', 'border-orange-500');
                selectAllCheck.classList.remove('border-slate-300');
            } else {
                selectAllCheck.classList.remove('bg-orange-500', 'border-orange-500');
                selectAllCheck.classList.add('border-slate-300');
            }
        }

        function confirmSpeakSelection() {
            if (selectedScenes.length === 0) {
                alert("Please select at least one scene!");
                return;
            }
            document.getElementById('speakSelectionModal').remove();

            // Unlock and Switch to Speak Mode
            if (!unlockedPhases.includes('speak')) {
                unlockedPhases.push('speak');
            }

            // Since Speak logic isn't fully implemented in this prototype, 
            // we'll simulate the switch by unlocking and updating the UI
            isReadUnlocked = true; // Ensure Read remains unlocked

            // Visual update for GNB
            const speakBtn = document.querySelector('button[onclick="setPhase(\'speak\')"]');
            if (speakBtn) {
                speakBtn.removeAttribute('disabled');
                speakBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'text-slate-400');
                speakBtn.classList.add('text-slate-700');
                speakBtn.click(); // Trigger phase switch
            } else {
                setPhase('speak'); // Fallback
            }
        }

        function goToReadStep(step) {
            currentReadStep = step;
            renderReadPhase();
        }


        function prevScene() {
            if (currentSceneIndex > 0) {
                currentSceneIndex--;
                isScenePickerOpen = false;
                renderReadPhase();
            }
        }

        function toggleScenePicker() {
            isScenePickerOpen = !isScenePickerOpen;
            renderReadPhase();
        }

        function jumpToScene(index) {
            if (index <= maxReachedSceneIndex) {
                stopAudio();
                currentSceneIndex = index;
                isScenePickerOpen = false;
                renderReadPhase();
            }
        }

        function onVideoEnded() {
            // isReadUnlocked = true; // Don't unlock automatically yet
            document.getElementById('nextPhaseContainer').classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            document.getElementById('nextPhaseContainer').innerHTML = `
                <button onclick="isReadUnlocked=true; currentReadStep='selection'; setPhase('read'); renderReadPhase();"
                    class="px-12 py-6 bg-white rounded-full font-black text-slate-900 text-3xl shadow-[0_20px_50px_rgba(0,0,0,0.3)] hover:scale-110 active:scale-95 transition-all flex items-center gap-4 border-8 border-white group">
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-slate-400 text-xs font-black uppercase tracking-widest mb-1">Great Watching!</span>
                        <span class="font-fredoka uppercase text-4xl">Read Next</span>
                    </div>
                    <div class="w-14 h-14 bg-[#FF6B00] rounded-2xl flex items-center justify-center text-white group-hover:rotate-12 transition-transform shadow-lg">
                        <i data-lucide="chevron-right" class="w-10 h-10"></i>
                    </div>
                </button>
            `;
            lucide.createIcons();

            // Reset icons
            document.getElementById('centralPlayIcon').setAttribute('data-lucide', 'play');
            document.getElementById('playIcon').setAttribute('data-lucide', 'play');
            lucide.createIcons();
        }


        const bookContainer = document.getElementById('bookContainer');
        const scrollLeftBtn = document.getElementById('scrollLeftBtn');

        function scrollContainer(amount) {
            bookContainer.scrollBy({
                left: amount,
                behavior: 'smooth'
            });
        }

        bookContainer.addEventListener('scroll', () => {
            if (bookContainer.scrollLeft > 10) {
                scrollLeftBtn.classList.remove('invisible', 'opacity-0');
                scrollLeftBtn.classList.add('opacity-100');
            } else {
                scrollLeftBtn.classList.add('invisible', 'opacity-0');
                scrollLeftBtn.classList.remove('opacity-100');
            }
        });

        // Swipe / Drag Scroll Logic
        let isDown = false;
        let startX;
        let scrollLeftPos;

        bookContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            bookContainer.classList.remove('scroll-smooth');
            startX = e.pageX - bookContainer.offsetLeft;
            scrollLeftPos = bookContainer.scrollLeft;
        });

        bookContainer.addEventListener('mouseleave', () => {
            isDown = false;
        });

        bookContainer.addEventListener('mouseup', () => {
            isDown = false;
            bookContainer.classList.add('scroll-smooth');
        });

        bookContainer.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - bookContainer.offsetLeft;
            const walk = (x - startX) * 2;
            bookContainer.scrollLeft = scrollLeftPos - walk;
        });

        renderBooks();
        renderHero();
        lucide.createIcons();
    </script>
</body>

</html>